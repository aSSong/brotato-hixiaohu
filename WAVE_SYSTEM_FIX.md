# 波次系统修复说明 (v2.0)

## 修复的问题

### 问题1: 波次结束逻辑不准确 ✅
**原问题**: 
- 当击杀数达到目标时立即结束波次，但场上可能还有正在生成或存活的敌人
- 导致下一波提前开始，敌人混在一起

**解决方案**:
- 添加 `enemies_alive_this_wave` 变量追踪场上存活敌人数
- 波次结束条件改为：
  1. 击杀数达到总数 ✓
  2. 所有敌人都已生成 ✓
  3. 场上没有存活的敌人 ✓
- 只有三个条件都满足才结束波次

### 问题2: 计数不准确 ✅
**原问题**:
- 敌人生成失败时也会增加计数
- 导致显示的击杀数不准确（如6/10卡住）

**解决方案**:
- 移除 `wave_manager.enemies_spawned_this_wave += 1` 的直接操作
- 改为调用 `wave_manager.on_enemy_spawned()` 方法
- 只有成功生成并添加到场景树后才调用此方法
- 添加详细的生成日志，记录成功和失败情况

### 问题3: 商店关闭后不等待 ✅
**原问题**:
- 关闭商店后立即开始下一波
- 没有确认场上所有敌人都清理完毕

**解决方案**:
- 添加 `is_shop_open` 状态标记
- 商店关闭后通过状态检查而不是单纯等待信号
- 添加超时保护机制（60秒），避免永久卡住
- 短暂延迟（0.5秒）后再开始下一波

### 问题4: Ghost击杀计数 ✅
**分析结果**:
- Ghost击杀敌人**会正常计数**，这不是问题
- 敌人的 `enemy_killed` 信号会正确传递到 `wave_manager`
- 无论是玩家还是Ghost击杀，都会调用 `on_enemy_killed()`

## 核心改进

### 新增变量
```gdscript
var enemies_alive_this_wave: int = 0  # 场上存活敌人数
var is_shop_open: bool = false  # 商店状态
```

### 新增方法
```gdscript
func on_enemy_spawned() -> void:
    # 敌人成功生成时调用
    enemies_spawned_this_wave += 1
    enemies_alive_this_wave += 1
```

### 改进的波次结束条件
```gdscript
if enemies_killed_this_wave >= enemies_total_this_wave and \
   enemies_spawned_this_wave >= enemies_total_this_wave and \
   enemies_alive_this_wave <= 0:
    # 所有条件满足，结束波次
    _end_current_wave()
```

## 调试日志

### 波次开始
```
=== 开始第 X 波 ===
目标击杀数: 10
当前击杀: 0, 已生成: 0, 存活: 0
```

### 敌人生成
```
成功生成敌人: basic 位置: (100, 200)
敌人生成: 1/10 (存活:1)
```

### 敌人击杀
```
敌人击杀: 5/10 (已生成:7 存活:2)
```

### 波次结束
```
波次结束条件满足！
=== 第 X 波结束 ===
击杀: 10/10
已生成: 10 存活: 0
```

## 测试要点

### 测试1: 正常波次流程
1. 开始游戏，观察第一波
2. 击杀所有敌人
3. 确认升级商店弹出
4. 关闭商店
5. 确认场上没有敌人后才开始下一波

### 测试2: 计数准确性
1. 观察控制台日志
2. 击杀数应该与场上敌人数量一致
3. 不应出现"6/10"卡住的情况

### 测试3: Ghost击杀
1. 创建几个Ghost
2. 让Ghost击杀敌人
3. 确认击杀数正常增加
4. Ghost击杀也应该计入波次进度

### 测试4: 防护机制
1. 如果商店未能正常关闭
2. 60秒后应该强制继续游戏
3. 控制台会显示"商店等待超时！强制继续游戏"

## 修改的文件

1. **Scripts/enemies/wave_manager.gd**
   - 添加 `enemies_alive_this_wave` 和 `is_shop_open` 变量
   - 改进 `start_next_wave()` 添加详细日志
   - 改进 `on_enemy_killed()` 添加三重检查
   - 新增 `on_enemy_spawned()` 方法
   - 改进 `_end_current_wave()` 添加超时保护
   - 改进 `_on_shop_closed()` 添加状态更新

2. **Scripts/enemies/now_enemies.gd**
   - 改进 `spawn_enemy()` 只有成功生成才计数
   - 添加详细的生成日志
   - 添加生成失败的警告信息

## 预期效果

✅ **波次流程更清晰**: 必须清理完所有敌人才能进入下一波  
✅ **计数更准确**: 击杀数/总数显示正确，不会卡住  
✅ **日志更详细**: 方便排查问题  
✅ **防护更完善**: 避免因商店问题导致游戏卡住  
✅ **Ghost友好**: Ghost击杀敌人正常计入波次进度  

## 控制台输出示例

```
=== 开始第 1 波 ===
目标击杀数: 10
当前击杀: 0, 已生成: 0, 存活: 0
成功生成敌人: basic 位置: (956.1, 734.2)
敌人生成: 1/10 (存活:1)
成功生成敌人: basic 位置: (1245.8, 456.3)
敌人生成: 2/10 (存活:2)
...
敌人击杀: 1/10 (已生成:10 存活:9)
敌人击杀: 2/10 (已生成:10 存活:8)
...
敌人击杀: 10/10 (已生成:10 存活:0)
波次结束条件满足！
=== 第 1 波结束 ===
击杀: 10/10
已生成: 10 存活: 0
通过组找到升级商店: ...
找到升级商店，正在打开...
收到商店关闭信号
商店已关闭，准备开始下一波...
=== 开始第 2 波 ===
...
```

现在波次系统应该运行得更加稳定和准确了！

