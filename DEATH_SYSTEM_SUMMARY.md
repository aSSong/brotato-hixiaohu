# æ­»äº¡å’Œå¤æ´»ç³»ç»Ÿ - å®ç°æ€»ç»“

## ğŸ‰ å®ç°å®Œæˆï¼

æ­»äº¡å’Œå¤æ´»ç³»ç»Ÿå·²ç»å®Œå…¨æŒ‰ç…§éœ€æ±‚å®ç°ã€‚

## ğŸ“‹ éœ€æ±‚å¯¹ç…§

| éœ€æ±‚ | çŠ¶æ€ | å®ç°æ–¹å¼ |
|------|------|---------|
| HP â‰¤ 0 è§¦å‘æ­»äº¡ | âœ… | DeathManager ç›‘å¬ player.hp_changed ä¿¡å· |
| 3ç§’å»¶è¿Ÿ | âœ… | death_timer è®¡æ—¶å™¨ |
| æš‚åœæ¸¸æˆ | âœ… | get_tree().paused = true |
| å¼¹å‡ºæ­»äº¡ç•Œé¢ | âœ… | death_ui.tscn åœºæ™¯ |
| 2ä¸ªé€‰é¡¹ï¼šæ”¾å¼ƒ/å¤æ´» | âœ… | ä¸¤ä¸ªæŒ‰é’® + ä¿¡å· |
| å¤æ´»è´¹ç”¨å…¬å¼ | âœ… | 5 * (revive_count + 1) |
| é‡‘å¸æ£€æŸ¥ | âœ… | ä¸å¤Ÿæ—¶ç¦ç”¨å¤æ´»æŒ‰é’® |
| æ”¾å¼ƒè¿”å›ä¸»èœå• | âœ… | change_scene_to_file() |
| å¤æ´»éšæœºä½ç½® | âœ… | ä» floor_layer éšæœºé€‰æ‹© |
| HPå…¨æ¢å¤ | âœ… | now_hp = max_hp |
| ä¿ç•™è¿›åº¦ | âœ… | ä¸é‡ç½®ä»»ä½•æ•°æ®ï¼ˆé™¤å¤æ´»æ¬¡æ•°é€’å¢ï¼‰ |
| æ”¾å¼ƒæ—¶é‡ç½® | âœ… | GameMain.reset_game() |

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         GameInitializer (é›†æˆå±‚)         â”‚
â”‚  - åˆ›å»º DeathManager                     â”‚
â”‚  - åˆ›å»º DeathUI                          â”‚
â”‚  - è¿æ¥å„ç»„ä»¶                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
        â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
        â†“            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DeathManager â”‚  â”‚   DeathUI    â”‚
â”‚  (é€»è¾‘å±‚)    â”‚â†â†’â”‚   (è¡¨ç°å±‚)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ ç›‘å¬
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Player    â”‚
â”‚  hp_changed  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‚ æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶ï¼ˆ4ä¸ªï¼‰

1. **Scripts/UI/death_ui.gd** (65è¡Œ)
   - èŒè´£ï¼šæ§åˆ¶æ­»äº¡UIæ˜¾ç¤ºå’Œäº¤äº’
   - åŠŸèƒ½ï¼šæ˜¾ç¤ºè´¹ç”¨ã€æŒ‰é’®çŠ¶æ€ã€å‘å‡ºä¿¡å·

2. **scenes/UI/death_ui.tscn** (60è¡Œ)
   - èŒè´£ï¼šæ­»äº¡UIåœºæ™¯
   - åŒ…å«ï¼šPanelã€æ ‡é¢˜ã€è¯´æ˜ã€è´¹ç”¨æ ‡ç­¾ã€2ä¸ªæŒ‰é’®

3. **Scripts/players/death_manager.gd** (235è¡Œ)
   - èŒè´£ï¼šç®¡ç†æ­»äº¡æµç¨‹å’Œå¤æ´»é€»è¾‘
   - åŠŸèƒ½ï¼š
     - ç›‘å¬HPå˜åŒ–
     - 3ç§’å»¶è¿Ÿè®¡æ—¶
     - å¤æ´»è´¹ç”¨è®¡ç®—
     - é‡‘å¸æ‰£é™¤
     - éšæœºä½ç½®å¤æ´»
     - æ¸¸æˆæš‚åœ/æ¢å¤

4. **Scripts/game_initializer.gd** (55è¡Œ)
   - èŒè´£ï¼šåˆå§‹åŒ–æ­»äº¡ç³»ç»Ÿ
   - åŠŸèƒ½ï¼šåˆ›å»ºå’Œè¿æ¥æ‰€æœ‰ç»„ä»¶

### ä¿®æ”¹æ–‡ä»¶ï¼ˆ2ä¸ªï¼‰

1. **Scripts/players/player.gd**
   - ä¿®æ”¹ï¼šç§»é™¤æ­»äº¡æ‰“å°ï¼Œè®© DeathManager å¤„ç†
   
2. **Scripts/GameMain.gd**
   - ä¿®æ”¹ï¼šæ·»åŠ  `revive_count` å˜é‡
   - ä¿®æ”¹ï¼šåœ¨ `reset_game()` ä¸­é‡ç½®å¤æ´»æ¬¡æ•°

### æ–‡æ¡£ï¼ˆ3ä¸ªï¼‰

1. **DEATH_SYSTEM_GUIDE.md** - å®Œæ•´æ–‡æ¡£
2. **DEATH_QUICK_START.md** - å¿«é€Ÿå¼€å§‹
3. **DEATH_SYSTEM_SUMMARY.md** - æœ¬æ–‡ä»¶

## ğŸ”‘ æ ¸å¿ƒä»£ç ç‰‡æ®µ

### æ­»äº¡è§¦å‘

```gdscript
# death_manager.gd
func _on_player_hp_changed(current_hp: int, _max_hp: int):
    if current_hp <= 0 and not is_dead:
        _trigger_death()

func _trigger_death():
    is_dead = true
    death_timer = 3.0  # 3ç§’å»¶è¿Ÿ
    player.canMove = false
```

### å¤æ´»é€»è¾‘

```gdscript
# death_manager.gd
func _on_revive_requested():
    var cost = 5 * (revive_count + 1)
    
    if GameMain.gold < cost:
        return
    
    GameMain.remove_gold(cost)
    revive_count += 1
    _revive_player()

func _revive_player():
    player.now_hp = player.max_hp
    _respawn_player_at_random_position()
    player.canMove = true
    get_tree().paused = false
```

### é‡‘å¸æ£€æŸ¥

```gdscript
# death_ui.gd
func show_death_screen(revive_count: int, current_gold: int):
    revive_cost = 5 * (revive_count + 1)
    can_afford = current_gold >= revive_cost
    
    if can_afford:
        revive_button.disabled = false
        revive_button.text = "å¤æ´» (-%dé‡‘å¸)" % revive_cost
    else:
        revive_button.disabled = true
        revive_button.text = "é‡‘å¸ä¸è¶³"
```

## ğŸ”„ å®Œæ•´æµç¨‹å›¾

```
[ç©å®¶å—åˆ°ä¼¤å®³]
    â†“
player.player_hurt(damage)
    â†“
now_hp -= damage
    â†“
hp_changed.emit(now_hp, max_hp)
    â†“
â”Œâ”€ now_hp > 0? â”€â”€â†’ ç»§ç»­æ¸¸æˆ
â”‚
â””â”€ now_hp <= 0
    â†“
death_manager._on_player_hp_changed()
    â†“
_trigger_death()
    â”œâ”€ is_dead = true
    â”œâ”€ death_timer = 3.0
    â””â”€ player.canMove = false
    â†“
ã€ç­‰å¾…3ç§’ã€‘
    â†“
_show_death_ui()
    â”œâ”€ get_tree().paused = true
    â””â”€ death_ui.show_death_screen()
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           â”‚
â†“ ç©å®¶é€‰æ‹©å¤æ´»              â†“ ç©å®¶é€‰æ‹©æ”¾å¼ƒ
â”‚                           â”‚
revive_requested.emit()     give_up_requested.emit()
â”‚                           â”‚
_on_revive_requested()      _on_give_up_requested()
â”‚                           â”‚
â”œâ”€ æ£€æŸ¥é‡‘å¸                 â”œâ”€ get_tree().paused = false
â”œâ”€ æ‰£é™¤é‡‘å¸                 â”œâ”€ GameMain.reset_game()
â”œâ”€ revive_count++          â””â”€ change_scene("start_menu.tscn")
â””â”€ _revive_player()
    â”œâ”€ now_hp = max_hp
    â”œâ”€ éšæœºä½ç½®
    â”œâ”€ canMove = true
    â””â”€ paused = false
    â†“
ã€æ¸¸æˆç»§ç»­ã€‘
```

## ğŸ¯ ä½¿ç”¨æ­¥éª¤

### 1. åœ¨ bg_map.tscn ä¸­æ·»åŠ èŠ‚ç‚¹

```
bg_map (æ ¹èŠ‚ç‚¹)
â”œâ”€ ... (ç°æœ‰èŠ‚ç‚¹)
â””â”€ GameInitializer (Node2D) â† æ·»åŠ è¿™ä¸ª
   â””â”€ è„šæœ¬: game_initializer.gd
```

### 2. è¿è¡Œæ¸¸æˆæµ‹è¯•

```bash
# è§‚å¯Ÿæ—¥å¿—è¾“å‡º
[GameInitializer] æ¸¸æˆåˆå§‹åŒ–å®Œæˆ
[DeathManager] åˆå§‹åŒ–
...
```

### 3. æµ‹è¯•åœºæ™¯

**åœºæ™¯1ï¼šé‡‘å¸å……è¶³å¤æ´»**
```
é‡‘å¸: 50
HP: 100 â†’ 0 (å—ä¼¤)
3ç§’å â†’ æ­»äº¡ç•Œé¢
å¤æ´»è´¹ç”¨: 5
ç‚¹å‡»å¤æ´» â†’ æ‰£é™¤5é‡‘å¸ â†’ éšæœºä½ç½® â†’ HP:100
é‡‘å¸: 45
å¤æ´»æ¬¡æ•°: 1
```

**åœºæ™¯2ï¼šé‡‘å¸ä¸è¶³**
```
é‡‘å¸: 8
å¤æ´»æ¬¡æ•°: 1
HP: 100 â†’ 0
3ç§’å â†’ æ­»äº¡ç•Œé¢
å¤æ´»è´¹ç”¨: 10 (5 Ã— 2)
å¤æ´»æŒ‰é’®: ã€é‡‘å¸ä¸è¶³ã€‘(ç¦ç”¨)
åªèƒ½é€‰æ‹©ï¼šæ”¾å¼ƒ
```

**åœºæ™¯3ï¼šå¤šæ¬¡å¤æ´»**
```
ç¬¬1æ¬¡æ­»äº¡ â†’ å¤æ´» 5 é‡‘å¸
ç¬¬2æ¬¡æ­»äº¡ â†’ å¤æ´» 10 é‡‘å¸
ç¬¬3æ¬¡æ­»äº¡ â†’ å¤æ´» 15 é‡‘å¸
...
```

## ğŸ’¡ è®¾è®¡äº®ç‚¹

### 1. è§£è€¦è®¾è®¡
- DeathManager è´Ÿè´£é€»è¾‘
- DeathUI è´Ÿè´£è¡¨ç°
- GameInitializer è´Ÿè´£é›†æˆ
- å„ç»„ä»¶é€šè¿‡ä¿¡å·é€šä¿¡

### 2. å®‰å…¨æ£€æŸ¥
- é‡‘å¸ä¸è¶³æ—¶ç¦ç”¨æŒ‰é’®
- é˜²æ­¢é‡å¤æ­»äº¡è§¦å‘
- å¼•ç”¨æœ‰æ•ˆæ€§æ£€æŸ¥

### 3. ç”¨æˆ·ä½“éªŒ
- 3ç§’ç¼“å†²æ—¶é—´
- æ¸…æ™°çš„è´¹ç”¨æ˜¾ç¤º
- æ¸¸æˆæš‚åœï¼Œç©å®¶ä¸ä¼šé”™è¿‡ä¿¡æ¯

### 4. å¯æ‰©å±•æ€§
- æ˜“äºä¿®æ”¹è´¹ç”¨å…¬å¼
- æ˜“äºæ›´æ”¹å¤æ´»ä½ç½®ç­–ç•¥
- æ˜“äºè°ƒæ•´å»¶è¿Ÿæ—¶é—´

### 5. è°ƒè¯•å‹å¥½
- å®Œæ•´çš„æ—¥å¿—è¾“å‡º
- æ¸…æ™°çš„çŠ¶æ€è¿½è¸ª
- è¯¦ç»†çš„é”™è¯¯æç¤º

## ğŸ“Š æµ‹è¯•æ¸…å•

- [ ] æ·»åŠ  GameInitializer èŠ‚ç‚¹åˆ° bg_map.tscn
- [ ] è¿è¡Œæ¸¸æˆ
- [ ] è®©ç©å®¶HPé™åˆ°0
- [ ] è§‚å¯Ÿ3ç§’å»¶è¿Ÿ
- [ ] ç¡®è®¤æ­»äº¡ç•Œé¢æ˜¾ç¤º
- [ ] æµ‹è¯•å¤æ´»ï¼ˆé‡‘å¸å……è¶³ï¼‰
- [ ] æµ‹è¯•æ”¾å¼ƒ
- [ ] æµ‹è¯•é‡‘å¸ä¸è¶³åœºæ™¯
- [ ] æµ‹è¯•å¤šæ¬¡å¤æ´»
- [ ] æ£€æŸ¥è¿›åº¦ä¿ç•™
- [ ] æ£€æŸ¥æ”¾å¼ƒåæ•°æ®é‡ç½®

## ğŸ¨ å¯è‡ªå®šä¹‰é¡¹

å‚è€ƒ `DEATH_SYSTEM_GUIDE.md` äº†è§£å¦‚ä½•è‡ªå®šä¹‰ï¼š

1. **æ­»äº¡å»¶è¿Ÿæ—¶é—´** (å½“å‰: 3ç§’)
2. **å¤æ´»è´¹ç”¨å…¬å¼** (å½“å‰: 5 Ã— (n+1))
3. **å¤æ´»ä½ç½®ç­–ç•¥** (å½“å‰: éšæœº)
4. **UIå¤–è§‚** (é¢œè‰²ã€å¤§å°ã€æ–‡æœ¬)
5. **è¿”å›åœºæ™¯** (å½“å‰: start_menu.tscn)

## ğŸ“ˆ æ€§èƒ½å½±å“

- âœ… æå°ï¼šåªåœ¨æ­»äº¡æ—¶æ¿€æ´»
- âœ… æ— è¿è¡Œæ—¶å¼€é”€ï¼ˆæ­»äº¡å‰ï¼‰
- âœ… UIåªåœ¨éœ€è¦æ—¶æ˜¾ç¤º

## ğŸ”’ å¥å£®æ€§

- âœ… é˜²æ­¢ç©ºå¼•ç”¨
- âœ… å®‰å…¨çš„é‡‘å¸æ£€æŸ¥
- âœ… æš‚åœçŠ¶æ€ç®¡ç†
- âœ… åœºæ™¯åˆ‡æ¢ä¿æŠ¤
- âœ… é‡å¤è§¦å‘é˜²æŠ¤

---

## ğŸš€ ä¸‹ä¸€æ­¥

**æ·»åŠ  GameInitializer èŠ‚ç‚¹åˆ° bg_map.tscnï¼Œç„¶åè¿è¡Œæµ‹è¯•ï¼**

ç³»ç»Ÿå·²ç»å®Œå…¨å®ç°ï¼Œæ–‡æ¡£é½å…¨ï¼Œéšæ—¶å¯ä»¥ä½¿ç”¨ã€‚ğŸ®

