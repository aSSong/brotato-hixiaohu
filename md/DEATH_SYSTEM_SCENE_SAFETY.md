# æ­»äº¡ç³»ç»Ÿ - åœºæ™¯åˆ‡æ¢å®‰å…¨æ€§ä¿®å¤

## ğŸ› é—®é¢˜

ç‚¹å‡»"æ”¾å¼ƒ"åæŠ¥é”™ï¼š
```
Cannot call method 'create_timer' on a null value.
```

**ä½ç½®**ï¼š`Scripts/enemies/wave_system_v3.gd` - `_show_shop()` å‡½æ•°

## ğŸ” é—®é¢˜åˆ†æ

### å‘ç”Ÿåœºæ™¯

```
ç©å®¶HPé™åˆ°0
    â†“
ç­‰å¾…3ç§’æœŸé—´ï¼Œç©å®¶å‡»æ€äº†æœ€åä¸€ä¸ªæ•Œäºº
    â†“
æ³¢æ¬¡å®Œæˆ â†’ _check_wave_complete()
    â†“
è°ƒç”¨ _show_shop()
    â†“
ã€å¼€å§‹ç­‰å¾…2ç§’ã€‘
print("æ³¢æ¬¡å®Œæˆï¼Œ2ç§’åæ‰“å¼€å•†åº—...")
await get_tree().create_timer(2.0).timeout  â† åœ¨è¿™é‡Œç­‰å¾…
    â†“
ã€æ­¤æ—¶ç©å®¶ç‚¹å‡»äº†"æ”¾å¼ƒ"ã€‘
    â†“
death_manager åˆ‡æ¢åœºæ™¯åˆ° start_menu.tscn
    â†“
bg_map.tscn åœºæ™¯è¢«å¸è½½
wave_system_v3 èŠ‚ç‚¹è¢«ç§»é™¤
get_tree() è¿”å› null
    â†“
ã€2ç§’è®¡æ—¶å™¨ç»“æŸï¼Œå°è¯•ç»§ç»­æ‰§è¡Œã€‘
await åé¢çš„ä»£ç æ‰§è¡Œ
ä½†æ˜¯ get_tree() å·²ç»æ˜¯ null âŒ
    â†“
é”™è¯¯ï¼šCannot call method 'create_timer' on a null value
```

### æ ¸å¿ƒé—®é¢˜

åœ¨ `await` æœŸé—´ï¼Œåœºæ™¯å¯èƒ½è¢«åˆ‡æ¢ï¼Œå¯¼è‡´èŠ‚ç‚¹ä¸å†åœ¨åœºæ™¯æ ‘ä¸­ï¼š

```gdscript
await get_tree().create_timer(2.0).timeout  // å¼€å§‹ç­‰å¾…
// ã€åœ¨è¿™2ç§’å†…ï¼Œåœºæ™¯å¯èƒ½è¢«åˆ‡æ¢ã€‘
get_tree().paused = true  // â† è¿™é‡Œ get_tree() å¯èƒ½å·²ç»æ˜¯ null
```

## âœ… è§£å†³æ–¹æ¡ˆ

åœ¨æ¯ä¸ª `await` å‰åæ·»åŠ  `is_inside_tree()` æ£€æŸ¥ï¼š

### ä¿®å¤1ï¼š`_show_shop()` å‡½æ•°

```gdscript
func _show_shop() -> void:
    if current_state != WaveState.WAVE_COMPLETE:
        return
    
    print("[WaveSystem V3] æ³¢æ¬¡å®Œæˆï¼Œ2ç§’åæ‰“å¼€å•†åº—...")
    
    # æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦è¿˜åœ¨åœºæ™¯æ ‘ä¸­
    if not is_inside_tree():
        return
    
    await get_tree().create_timer(2.0).timeout
    
    # å†æ¬¡æ£€æŸ¥ï¼ˆå¯èƒ½åœ¨ç­‰å¾…æœŸé—´åœºæ™¯è¢«åˆ‡æ¢ï¼‰
    if not is_inside_tree():
        return
    
    # ç»§ç»­åç»­é€»è¾‘...
```

### ä¿®å¤2ï¼š`_on_shop_closed()` å‡½æ•°

```gdscript
func _on_shop_closed() -> void:
    # ...
    
    # å»¶è¿Ÿå¼€å§‹ä¸‹ä¸€æ³¢
    if not is_inside_tree():
        return
    
    await get_tree().create_timer(1.0).timeout
    
    # å†æ¬¡æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
    if not is_inside_tree():
        return
    
    if current_wave < wave_configs.size():
        start_next_wave()
```

## ğŸ›¡ï¸ é˜²æŠ¤æœºåˆ¶

### `is_inside_tree()` çš„ä½œç”¨

```gdscript
is_inside_tree()
```

è¿”å›å€¼ï¼š
- `true` - èŠ‚ç‚¹åœ¨åœºæ™¯æ ‘ä¸­ï¼Œå¯ä»¥å®‰å…¨ä½¿ç”¨ `get_tree()`
- `false` - èŠ‚ç‚¹å·²è¢«ç§»é™¤æˆ–åœºæ™¯å·²åˆ‡æ¢ï¼Œä¸åº”ç»§ç»­æ‰§è¡Œ

### æ£€æŸ¥æ—¶æœº

```
await ä¹‹å‰æ£€æŸ¥
    â†“
await get_tree().create_timer(...).timeout
    â†“
await ä¹‹åç«‹å³æ£€æŸ¥
```

**ä¸ºä»€ä¹ˆéœ€è¦ä¸¤æ¬¡æ£€æŸ¥ï¼Ÿ**
1. **await å‰**ï¼šç¡®ä¿å¯ä»¥å®‰å…¨åˆ›å»ºè®¡æ—¶å™¨
2. **await å**ï¼šç¡®ä¿åœ¨ç­‰å¾…æœŸé—´åœºæ™¯æ²¡æœ‰è¢«åˆ‡æ¢

## ğŸ“Š å®Œæ•´æµç¨‹ï¼ˆå¸¦ä¿æŠ¤ï¼‰

```
æ³¢æ¬¡å®Œæˆ
    â†“
_show_shop()
    â†“
æ£€æŸ¥ is_inside_tree() âœ“
    â†“
await 2ç§’
    â†“
ã€å¦‚æœåœ¨ç­‰å¾…æœŸé—´ç‚¹å‡»"æ”¾å¼ƒ"ã€‘
â”œâ”€ åœºæ™¯åˆ‡æ¢åˆ°ä¸»èœå•
â”œâ”€ wave_system_v3 è¢«ç§»é™¤
â””â”€ is_inside_tree() = false
    â†“
æ£€æŸ¥ is_inside_tree() âœ—
    â†“
returnï¼ˆæå‰é€€å‡ºï¼Œä¸å†æ‰§è¡Œåç»­ä»£ç ï¼‰
    â†“
âœ… ä¸ä¼šæœ‰é”™è¯¯ï¼
```

## ğŸ¯ ä¿®å¤çš„åœºæ™¯

### åœºæ™¯1ï¼šæ­£å¸¸æ³¢æ¬¡å®Œæˆ

```
æ³¢æ¬¡å®Œæˆ
    â†“
ç­‰å¾…2ç§’ï¼ˆç©å®¶è¿˜æ´»ç€ï¼‰
    â†“
is_inside_tree() = true âœ“
    â†“
å•†åº—æ‰“å¼€ âœ“
```

### åœºæ™¯2ï¼šç­‰å¾…æœŸé—´ç©å®¶æ­»äº¡å¹¶æ”¾å¼ƒ

```
æ³¢æ¬¡å®Œæˆ
    â†“
å¼€å§‹ç­‰å¾…2ç§’
    â†“
ã€1ç§’åç©å®¶ç‚¹å‡»"æ”¾å¼ƒ"ã€‘
    â†“
åœºæ™¯åˆ‡æ¢
    â†“
is_inside_tree() = false âœ—
    â†“
æå‰é€€å‡º âœ“
```

### åœºæ™¯3ï¼šå•†åº—å…³é—­ååˆ‡æ¢åœºæ™¯

```
å•†åº—å…³é—­
    â†“
å¼€å§‹ç­‰å¾…1ç§’
    â†“
ã€æ­¤æ—¶ç©å®¶åšäº†æŸäº›æ“ä½œå¯¼è‡´åœºæ™¯åˆ‡æ¢ã€‘
    â†“
is_inside_tree() = false âœ—
    â†“
æå‰é€€å‡º âœ“
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### `is_inside_tree()` vs `get_tree() != null`

```gdscript
// ä¸æ¨è âŒ
if get_tree() != null:
    await get_tree().create_timer(1.0).timeout

// æ¨è âœ…
if is_inside_tree():
    await get_tree().create_timer(1.0).timeout
```

**åŸå› **ï¼š
- `is_inside_tree()` æ˜¯ä¸“é—¨ç”¨æ¥æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦åœ¨åœºæ™¯æ ‘ä¸­
- æ›´è¯­ä¹‰åŒ–ï¼Œæ›´æ¸…æ™°
- æ€§èƒ½æ›´å¥½ï¼ˆä¸éœ€è¦è·å–æ ‘å¼•ç”¨ï¼‰

### ä¸ºä»€ä¹ˆä¸èƒ½åªæ£€æŸ¥ä¸€æ¬¡ï¼Ÿ

```gdscript
// é”™è¯¯ç¤ºä¾‹ âŒ
func _show_shop():
    if not is_inside_tree():
        return
    
    await get_tree().create_timer(2.0).timeout
    // è¿™é‡Œå¯èƒ½åœºæ™¯å·²ç»åˆ‡æ¢äº†ï¼
    get_tree().paused = true  // â† å¯èƒ½å‡ºé”™
```

**é—®é¢˜**ï¼š
- `await` ä¼šæš‚åœæ‰§è¡Œ
- åœ¨æš‚åœæœŸé—´ï¼Œåœºæ™¯å¯èƒ½è¢«åˆ‡æ¢
- ç»§ç»­æ‰§è¡Œæ—¶ï¼ŒèŠ‚ç‚¹å¯èƒ½å·²ä¸åœ¨åœºæ™¯æ ‘ä¸­

**æ­£ç¡®åšæ³•**ï¼š
```gdscript
// æ­£ç¡®ç¤ºä¾‹ âœ…
func _show_shop():
    if not is_inside_tree():
        return
    
    await get_tree().create_timer(2.0).timeout
    
    if not is_inside_tree():  // â† å†æ¬¡æ£€æŸ¥ï¼
        return
    
    get_tree().paused = true  // â† å®‰å…¨
```

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

**Scripts/enemies/wave_system_v3.gd**
- `_show_shop()` - æ·»åŠ ä¸¤æ¬¡ `is_inside_tree()` æ£€æŸ¥
- `_on_shop_closed()` - æ·»åŠ ä¸¤æ¬¡ `is_inside_tree()` æ£€æŸ¥

## ğŸ§ª æµ‹è¯•åœºæ™¯

### æµ‹è¯•1ï¼šæ­£å¸¸æµç¨‹
1. ç©å®¶å‡»æ€æ‰€æœ‰æ•Œäºº
2. ç­‰å¾…2ç§’
3. å•†åº—æ‰“å¼€
4. âœ… æ— é”™è¯¯

### æµ‹è¯•2ï¼šæ³¢æ¬¡å®Œæˆåç«‹å³æ”¾å¼ƒ
1. ç©å®¶HPé™åˆ°0ï¼Œä½†å‡»æ€äº†æœ€åçš„æ•Œäºº
2. æ³¢æ¬¡å®Œæˆï¼Œå¼€å§‹ç­‰å¾…2ç§’
3. ç©å®¶ç‚¹å‡»"æ”¾å¼ƒ"
4. åœºæ™¯åˆ‡æ¢
5. âœ… æ— é”™è¯¯ï¼ˆæå‰é€€å‡ºï¼‰

### æµ‹è¯•3ï¼šå•†åº—å…³é—­ååˆ‡æ¢åœºæ™¯
1. å•†åº—æ‰“å¼€
2. å•†åº—å…³é—­ï¼Œå¼€å§‹ç­‰å¾…1ç§’
3. ï¼ˆæŸäº›æƒ…å†µå¯¼è‡´åœºæ™¯åˆ‡æ¢ï¼‰
4. âœ… æ— é”™è¯¯ï¼ˆæå‰é€€å‡ºï¼‰

## ğŸ’¡ æœ€ä½³å®è·µ

### åœ¨æ‰€æœ‰ await ä½¿ç”¨åœºæ™¯ä¸­åº”ç”¨

```gdscript
// æ¨¡æ¿
func my_async_function():
    // 1. æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
    if not is_inside_tree():
        return
    
    // 2. å¼‚æ­¥æ“ä½œ
    await get_tree().create_timer(1.0).timeout
    
    // 3. å†æ¬¡æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
    if not is_inside_tree():
        return
    
    // 4. ç»§ç»­åç»­é€»è¾‘
    // ...
```

### é€‚ç”¨åœºæ™¯

ä»»ä½•ä½¿ç”¨ `await` çš„åœ°æ–¹ï¼Œå¦‚æœï¼š
- åœ¨ç­‰å¾…æœŸé—´å¯èƒ½å‘ç”Ÿåœºæ™¯åˆ‡æ¢
- åœ¨ç­‰å¾…æœŸé—´èŠ‚ç‚¹å¯èƒ½è¢«ç§»é™¤
- éœ€è¦ä½¿ç”¨ `get_tree()` ç­‰åœºæ™¯æ ‘ç›¸å…³æ–¹æ³•

éƒ½åº”è¯¥æ·»åŠ  `is_inside_tree()` æ£€æŸ¥ã€‚

---

**ç°åœ¨ç‚¹å‡»"æ”¾å¼ƒ"ä¸ä¼šå†æŠ¥é”™äº†ï¼** âœ…

