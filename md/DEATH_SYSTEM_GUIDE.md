# æ­»äº¡å’Œå¤æ´»ç³»ç»Ÿ - ä½¿ç”¨è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ç©å®¶HP â‰¤ 0æ—¶è§¦å‘æ­»äº¡ï¼Œ3ç§’åå¼¹å‡ºæ­»äº¡ç•Œé¢ï¼Œç©å®¶å¯ä»¥é€‰æ‹©ï¼š
1. **å¤æ´»**ï¼šæ¶ˆè€—é‡‘å¸ï¼Œåœ¨éšæœºä½ç½®å¤æ´»ï¼ŒHPå…¨æ¢å¤ï¼Œç»§ç»­æ¸¸æˆ
2. **æ”¾å¼ƒ**ï¼šç»“æŸæ¸¸æˆï¼Œè¿”å›ä¸»èœå•

## ğŸ® æ ¸å¿ƒç‰¹æ€§

### æ­»äº¡æµç¨‹
```
HP â‰¤ 0
    â†“
ç¦æ­¢ç§»åŠ¨
    â†“
ç­‰å¾… 3 ç§’
    â†“
æš‚åœæ¸¸æˆ
    â†“
å¼¹å‡ºæ­»äº¡ç•Œé¢
```

### å¤æ´»æœºåˆ¶
- **è´¹ç”¨å…¬å¼**ï¼š`5 Ã— (ç´¯è®¡å¤æ´»æ¬¡æ•° + 1)`
  - ç¬¬1æ¬¡å¤æ´»ï¼š5 é‡‘å¸
  - ç¬¬2æ¬¡å¤æ´»ï¼š10 é‡‘å¸
  - ç¬¬3æ¬¡å¤æ´»ï¼š15 é‡‘å¸
  - ...

- **å¤æ´»æ•ˆæœ**ï¼š
  - âœ… HP å…¨æ¢å¤
  - âœ… åœ¨å¯è¡Œèµ°åŒºåŸŸéšæœºä½ç½®å¤æ´»
  - âœ… ä¿ç•™æ‰€æœ‰è¿›åº¦ï¼ˆé‡‘å¸ã€é’¥åŒ™ã€æ³¢æ¬¡ã€æ­¦å™¨ã€ç­‰çº§ç­‰ï¼‰
  - âœ… æ¸¸æˆç»§ç»­

- **é‡‘å¸ä¸è¶³**ï¼š
  - å¤æ´»æŒ‰é’®æ˜¾ç¤º"é‡‘å¸ä¸è¶³"
  - æŒ‰é’®ç¦ç”¨ï¼Œæ— æ³•ç‚¹å‡»
  - åªèƒ½é€‰æ‹©æ”¾å¼ƒ

### æ”¾å¼ƒæœºåˆ¶
- è¿”å›ä¸»èœå• (`start_menu.tscn`)
- é‡ç½®æ¸¸æˆæ•°æ®ï¼ˆé‡‘å¸ã€é’¥åŒ™ã€åˆ†æ•°ã€å¤æ´»æ¬¡æ•°ç­‰ï¼‰
- ä¸ä¿ç•™ä»»ä½•è¿›åº¦

## ğŸ“‚ æ–‡ä»¶ç»“æ„

### æ–°å»ºæ–‡ä»¶

1. **Scripts/UI/death_ui.gd**
   - æ­»äº¡UIæ§åˆ¶è„šæœ¬
   - æ˜¾ç¤ºæ­»äº¡ç•Œé¢å’ŒæŒ‰é’®
   - å‘å‡ºå¤æ´»/æ”¾å¼ƒä¿¡å·

2. **scenes/UI/death_ui.tscn**
   - æ­»äº¡UIåœºæ™¯
   - åŒ…å«æ ‡é¢˜ã€ä¿¡æ¯ã€è´¹ç”¨æ ‡ç­¾å’Œä¸¤ä¸ªæŒ‰é’®

3. **Scripts/players/death_manager.gd**
   - æ­»äº¡ç®¡ç†å™¨
   - ç›‘å¬ç©å®¶HPå˜åŒ–
   - å¤„ç†æ­»äº¡æµç¨‹ï¼ˆ3ç§’å»¶è¿Ÿï¼‰
   - å¤„ç†å¤æ´»/æ”¾å¼ƒé€»è¾‘
   - ç®¡ç†å¤æ´»æ¬¡æ•°

4. **Scripts/game_initializer.gd**
   - æ¸¸æˆåˆå§‹åŒ–è„šæœ¬
   - åˆ›å»ºå¹¶è¿æ¥æ­»äº¡ç³»ç»Ÿç»„ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶

1. **Scripts/players/player.gd**
   - ç§»é™¤æ­»äº¡æ‰“å°
   - æ­»äº¡é€»è¾‘ç”± DeathManager å¤„ç†

2. **Scripts/GameMain.gd**
   - æ·»åŠ  `revive_count: int = 0`
   - åœ¨ `reset_game()` ä¸­é‡ç½®å¤æ´»æ¬¡æ•°

## ğŸ”§ é›†æˆæ–¹æ³•

### æ–¹æ³•1ï¼šåœ¨bg_map.tscnä¸­æ·»åŠ åˆå§‹åŒ–èŠ‚ç‚¹

åœ¨ `bg_map.tscn` ä¸­æ·»åŠ ä¸€ä¸ª Node2D èŠ‚ç‚¹ï¼š
1. æ·»åŠ èŠ‚ç‚¹ï¼šNode2D
2. å‘½åä¸ºï¼šGameInitializer
3. é™„åŠ è„šæœ¬ï¼š`Scripts/game_initializer.gd`

### æ–¹æ³•2ï¼šåœ¨ç°æœ‰è„šæœ¬ä¸­åˆå§‹åŒ–

å¦‚æœ bg_map æœ‰ä¸»è„šæœ¬ï¼Œåœ¨å…¶ `_ready()` ä¸­æ·»åŠ ï¼š

```gdscript
func _ready():
    # ... å…¶ä»–åˆå§‹åŒ–ä»£ç  ...
    
    # åˆå§‹åŒ–æ­»äº¡ç³»ç»Ÿ
    _init_death_system()

func _init_death_system():
    var initializer = load("res://Scripts/game_initializer.gd").new()
    add_child(initializer)
```

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### æµ‹è¯•æ­»äº¡ç³»ç»Ÿ

1. **è®©ç©å®¶å—ä¼¤**ï¼š
   - é è¿‘æ•Œäººè®©æ•Œäººæ”»å‡»
   - ç­‰å¾…HPé™åˆ°0

2. **è§‚å¯Ÿæµç¨‹**ï¼š
```
[DeathManager] ç©å®¶æ­»äº¡ï¼3ç§’åæ˜¾ç¤ºæ­»äº¡ç•Œé¢...
[DeathManager] å½“å‰å¤æ´»æ¬¡æ•°: 0
ã€ç­‰å¾…3ç§’ã€‘
[DeathManager] æ˜¾ç¤ºæ­»äº¡UI | é‡‘å¸:50 å¤æ´»è´¹ç”¨:5
[DeathUI] æ˜¾ç¤ºæ­»äº¡ç•Œé¢ | å¤æ´»æ¬¡æ•°:0 è´¹ç”¨:5 å½“å‰é‡‘å¸:50
```

3. **é€‰æ‹©å¤æ´»**ï¼š
```
[DeathUI] ç©å®¶é€‰æ‹©å¤æ´»
[DeathManager] ç©å®¶å¤æ´»ï¼èŠ±è´¹:5 å‰©ä½™é‡‘å¸:45 ç´¯è®¡å¤æ´»æ¬¡æ•°:1
[DeathManager] ç©å®¶å·²å¤æ´» | HP:100/100 ä½ç½®:Vector2(...)
```

4. **å†æ¬¡æ­»äº¡**ï¼š
```
[DeathManager] ç©å®¶æ­»äº¡ï¼3ç§’åæ˜¾ç¤ºæ­»äº¡ç•Œé¢...
[DeathManager] å½“å‰å¤æ´»æ¬¡æ•°: 1
[DeathManager] æ˜¾ç¤ºæ­»äº¡UI | é‡‘å¸:45 å¤æ´»è´¹ç”¨:10
```

### é‡‘å¸ä¸è¶³åœºæ™¯

```
å½“å‰é‡‘å¸: 8
ç¬¬2æ¬¡å¤æ´»è´¹ç”¨: 10

æ­»äº¡ç•Œé¢æ˜¾ç¤ºï¼š
- å¤æ´»æŒ‰é’®ï¼šã€é‡‘å¸ä¸è¶³ã€‘ï¼ˆç¦ç”¨ï¼‰
- æ”¾å¼ƒæŒ‰é’®ï¼šã€æ”¾å¼ƒã€‘ï¼ˆå¯ç”¨ï¼‰
```

## ğŸ¨ UIè‡ªå®šä¹‰

### ä¿®æ”¹æ­»äº¡ç•Œé¢å¤–è§‚

ç¼–è¾‘ `scenes/UI/death_ui.tscn`ï¼š
- è°ƒæ•´ Panel å¤§å°/é¢œè‰²
- ä¿®æ”¹å­—ä½“å¤§å°
- è°ƒæ•´æŒ‰é’®æ ·å¼

### ä¿®æ”¹æ–‡æœ¬å†…å®¹

åœ¨ `Scripts/UI/death_ui.gd` ä¸­ä¿®æ”¹ï¼š

```gdscript
func show_death_screen(...):
    title_label.text = "æ¸¸æˆç»“æŸ"  # ä¿®æ”¹æ ‡é¢˜
    info_label.text = "ä½ æƒ³æ€ä¹ˆåšï¼Ÿ"  # ä¿®æ”¹è¯´æ˜
    # ...
```

## âš™ï¸ é…ç½®å‚æ•°

### æ­»äº¡å»¶è¿Ÿæ—¶é—´

åœ¨ `Scripts/players/death_manager.gd` ä¸­ï¼š

```gdscript
var death_delay: float = 3.0  # ä¿®æ”¹è¿™é‡Œï¼Œå•ä½ï¼šç§’
```

### å¤æ´»è´¹ç”¨å…¬å¼

åœ¨ `Scripts/players/death_manager.gd` ä¸­ä¿®æ”¹è´¹ç”¨è®¡ç®—ï¼š

```gdscript
# å½“å‰å…¬å¼ï¼š5 * (revive_count + 1)
func _on_revive_requested():
    var cost = 5 * (revive_count + 1)  # ä¿®æ”¹è¿™é‡Œ
    # ...

func get_next_revive_cost():
    return 5 * (revive_count + 1)  # åŒæ­¥ä¿®æ”¹
```

ä¾‹å¦‚ï¼Œæ”¹ä¸ºæŒ‡æ•°å¢é•¿ï¼š
```gdscript
var cost = 5 * (2 ** revive_count)  # 5, 10, 20, 40, 80...
```

### å¤æ´»ä½ç½®ç­–ç•¥

åœ¨ `Scripts/players/death_manager.gd` çš„ `_respawn_player_at_random_position()` ä¸­è‡ªå®šä¹‰ï¼š

```gdscript
func _respawn_player_at_random_position():
    # æ–¹æ¡ˆ1: éšæœºä½ç½®ï¼ˆå½“å‰å®ç°ï¼‰
    var random_cell = used_cells[randi() % used_cells.size()]
    
    # æ–¹æ¡ˆ2: è·ç¦»æ•Œäººæœ€è¿œçš„ä½ç½®
    # ... è‡ªå®šä¹‰é€»è¾‘ ...
    
    # æ–¹æ¡ˆ3: å›ºå®šå®‰å…¨ç‚¹
    # player.global_position = Vector2(0, 0)
```

## ğŸ” è°ƒè¯•ä¿¡æ¯

æ‰€æœ‰å…³é”®æ“ä½œéƒ½æœ‰æ—¥å¿—è¾“å‡ºï¼Œå‰ç¼€ä¸ºï¼š
- `[DeathManager]` - æ­»äº¡ç®¡ç†å™¨
- `[DeathUI]` - æ­»äº¡UI
- `[GameInitializer]` - æ¸¸æˆåˆå§‹åŒ–

### å¸¸è§æ—¥å¿—

```
[GameInitializer] æ¸¸æˆåˆå§‹åŒ–å®Œæˆ
[DeathManager] ç©å®¶æ­»äº¡ï¼3ç§’åæ˜¾ç¤ºæ­»äº¡ç•Œé¢...
[DeathManager] æ˜¾ç¤ºæ­»äº¡UI | é‡‘å¸:X å¤æ´»è´¹ç”¨:Y
[DeathUI] æ˜¾ç¤ºæ­»äº¡ç•Œé¢ | å¤æ´»æ¬¡æ•°:N ...
[DeathUI] ç©å®¶é€‰æ‹©å¤æ´»
[DeathManager] ç©å®¶å¤æ´»ï¼èŠ±è´¹:X ...
[DeathUI] ç©å®¶é€‰æ‹©æ”¾å¼ƒ
[GameMain] æ¸¸æˆæ•°æ®å·²é‡ç½®
```

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šæ­»äº¡ç•Œé¢ä¸æ˜¾ç¤º

**æ£€æŸ¥**ï¼š
1. æ˜¯å¦æ·»åŠ äº† GameInitializer èŠ‚ç‚¹ï¼Ÿ
2. æ—¥å¿—ä¸­æ˜¯å¦æœ‰ `[GameInitializer] æ¸¸æˆåˆå§‹åŒ–å®Œæˆ`ï¼Ÿ
3. æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—ï¼Ÿ

**è§£å†³**ï¼š
- ç¡®ä¿ `death_ui.tscn` è·¯å¾„æ­£ç¡®
- ç¡®ä¿ç©å®¶åœ¨ "player" ç»„ä¸­

### é—®é¢˜2ï¼šå¤æ´»åä½ç½®ä¸å¯¹

**æ£€æŸ¥**ï¼š
- floor_layer æ˜¯å¦åœ¨ "floor_layer" ç»„ä¸­ï¼Ÿ
- æ—¥å¿—ä¸­æ˜¯å¦æœ‰ `æ‰¾ä¸åˆ°floor_layer` è­¦å‘Šï¼Ÿ

**è§£å†³**ï¼š
- ç¡®ä¿åœ°å›¾å±‚èŠ‚ç‚¹åŠ å…¥äº† "floor_layer" ç»„
- æˆ–ä¿®æ”¹ `game_initializer.gd` ä¸­çš„æŸ¥æ‰¾é€»è¾‘

### é—®é¢˜3ï¼šæ”¾å¼ƒåè¿”å›é”™è¯¯åœºæ™¯

**æ£€æŸ¥**ï¼š
- ä¸»èœå•åœºæ™¯è·¯å¾„æ˜¯å¦ä¸º `res://scenes/UI/start_menu.tscn`ï¼Ÿ

**è§£å†³**ï¼š
- ä¿®æ”¹ `death_manager.gd` ä¸­çš„åœºæ™¯è·¯å¾„ï¼š
```gdscript
get_tree().change_scene_to_file("ä½ çš„ä¸»èœå•è·¯å¾„.tscn")
```

### é—®é¢˜4ï¼šå¤æ´»æ¬¡æ•°æ²¡æœ‰é‡ç½®

**æ£€æŸ¥**ï¼š
- æ˜¯å¦åœ¨ `GameMain.reset_game()` ä¸­é‡ç½®äº† `revive_count`ï¼Ÿ

**è§£å†³**ï¼š
- ç¡®è®¤ GameMain.gd å·²æ›´æ–°

## ğŸ“Š æ•°æ®æµå›¾

```
player.now_hp <= 0
    â†“
player.hp_changed.emit(0, max_hp)
    â†“
death_manager._on_player_hp_changed()
    â†“
death_manager._trigger_death()
    - player.canMove = false
    - å¯åŠ¨3ç§’è®¡æ—¶å™¨
    â†“
3ç§’å
    â†“
death_manager._show_death_ui()
    - get_tree().paused = true
    - death_ui.show_death_screen()
    â†“
ç”¨æˆ·ç‚¹å‡»ã€å¤æ´»ã€‘
    â†“
death_ui.revive_requested.emit()
    â†“
death_manager._on_revive_requested()
    - GameMain.remove_gold(cost)
    - revive_count += 1
    - _revive_player()
        - player.now_hp = max_hp
        - éšæœºä½ç½®
        - player.canMove = true
        - get_tree().paused = false
```

## âœ… æµ‹è¯•æ¸…å•

- [ ] HPé™åˆ°0æ—¶ï¼Œ3ç§’åæ˜¾ç¤ºæ­»äº¡ç•Œé¢
- [ ] é‡‘å¸è¶³å¤Ÿæ—¶ï¼Œå¯ä»¥å¤æ´»
- [ ] å¤æ´»åHPå…¨æ¢å¤
- [ ] å¤æ´»åä½ç½®éšæœº
- [ ] å¤æ´»åæ¸¸æˆç»§ç»­ï¼Œè¿›åº¦ä¿ç•™
- [ ] å¤æ´»è´¹ç”¨éšæ¬¡æ•°é€’å¢ï¼ˆ5, 10, 15...ï¼‰
- [ ] é‡‘å¸ä¸è¶³æ—¶ï¼Œå¤æ´»æŒ‰é’®ç¦ç”¨
- [ ] ç‚¹å‡»æ”¾å¼ƒï¼Œè¿”å›ä¸»èœå•
- [ ] æ”¾å¼ƒåï¼Œæ¸¸æˆæ•°æ®é‡ç½®
- [ ] å¤šæ¬¡æ­»äº¡å’Œå¤æ´»ï¼Œç³»ç»Ÿç¨³å®š

ç°åœ¨ç³»ç»Ÿå·²ç»å®Œæˆï¼Œè¯·åœ¨ bg_map åœºæ™¯ä¸­æ·»åŠ  GameInitializer èŠ‚ç‚¹å³å¯ä½¿ç”¨ï¼ğŸ®

