# 墓碑救援系统 - 完整指南

## 概述

墓碑救援系统允许玩家复活后，消耗Master Key来救援自己死亡时留下的墓碑，将其转化为Ghost队友继续战斗。

## 核心功能

### 1. 死亡时创建墓碑和Ghost数据

当玩家死亡时：
- 在死亡位置生成墓碑（`res://assets/others/grave.png`）
- 保存玩家的职业ID和武器列表到`GhostData`
- 墓碑在玩家复活后**保留**，不会被清除

### 2. 救援范围检测

- **范围**：100个单位
- **进入范围时**：
  - 显示黄色半透明的范围圈（圆环）
  - 自动开始读条
- **离开范围时**：
  - 隐藏范围圈
  - 停止读条，进度清零

### 3. 读条系统

- **读条时间**：5秒
- **进度条位置**：紧贴墓碑上方
- **进度条样式**：
  - 横条白色ProgressBar
  - 显示倒计时数字（例如"4.3"秒）
- **中断条件**：
  - 玩家离开范围
  - 玩家再次死亡
  - 商店界面打开（游戏暂停）

### 4. 救援界面

读条完成后，弹出救援界面（游戏暂停），显示：
- **标题**："复活队友？"
- **Ghost信息**：
  - 职业名称
  - 武器列表（名称和等级）
  - 死亡次数（第几次死亡）
- **费用**：1个Master Key（显示当前拥有数量）
- **三个选项**：
  1. **同意救援**：消耗1个Master Key，将墓碑转化为Ghost
  2. **超度**：清除墓碑，不消耗任何资源
  3. **取消**：关闭界面，墓碑保留

### 5. Ghost创建

选择"同意救援"后：
- 消耗1个Master Key
- 在墓碑位置创建Ghost
- Ghost使用玩家死亡时的**职业外观**和**武器配置**
- Ghost加入队伍末尾，开始跟随
- 墓碑和救援UI被清除

### 6. 清理机制

墓碑在以下情况下被清除：
- **救援成功**：转化为Ghost
- **超度**：玩家选择超度
- **再次死亡**：玩家再次死亡时，旧墓碑被移除
- **放弃游戏**：点击死亡界面的"放弃"返回主菜单
- **胜利**：完成全部20波

## 技术实现

### 核心脚本

1. **`Scripts/data/ghost_data.gd`**
   - `GhostData`类：保存Ghost的职业、武器、死亡次数等数据
   - `from_player()`：从玩家创建Ghost数据
   - `get_weapons_description()`：生成武器描述文本

2. **`Scripts/players/grave_rescue_manager.gd`**
   - `GraveRescueManager`类：管理救援逻辑
   - 范围检测、读条、救援/超度处理
   - 创建进度条和范围圈UI

3. **`Scripts/UI/grave_rescue_ui.gd` + `scenes/UI/grave_rescue_ui.tscn`**
   - 救援界面UI
   - 显示Ghost信息和三个选项按钮

4. **`Scripts/players/death_manager.gd`**
   - 集成墓碑救援系统
   - 死亡时创建`GraveRescueManager`
   - 复活后墓碑保留

5. **`Scripts/players/ghost.gd`**
   - 修改`initialize()`，支持从已有数据创建Ghost
   - `use_existing_data`参数控制是否生成随机数据
   - `_setup_appearance()`使用职业ID选择外观

### 数据流

```
玩家死亡
  ↓
创建GhostData (职业 + 武器)
  ↓
创建墓碑 + GraveRescueManager
  ↓
玩家复活（墓碑保留）
  ↓
玩家接近墓碑
  ↓
显示范围圈 + 读条
  ↓
读条完成 → 救援界面
  ↓
选择 "同意救援"
  ↓
消耗Master Key → 创建Ghost（使用保存的数据）
  ↓
清除墓碑
```

## 使用场景

1. **正常流程**：
   - 玩家死亡 → 复活（花费金币） → 接近墓碑 → 读条 → 救援（花费Master Key） → 获得Ghost队友

2. **不救援**：
   - 玩家死亡 → 复活 → 接近墓碑 → 读条 → 超度 → 墓碑消失

3. **放弃救援**：
   - 玩家死亡 → 复活 → 接近墓碑 → 读条 → 取消 → 墓碑保留（可稍后再来）

4. **再次死亡**：
   - 玩家死亡 → 复活 → 未救援旧墓碑 → 再次死亡 → 旧墓碑被清除，新墓碑在新位置生成

## 边界情况处理

- **读条期间玩家死亡**：立即停止读条，移除旧墓碑，创建新墓碑
- **救援界面打开时玩家死亡**：关闭救援界面，立即停止读条（保护判定）
- **商店打开时**：无法读条（游戏暂停）
- **墓碑位置被墙挡住**：墓碑位置就是玩家死亡位置，玩家应该可以接近
- **Master Key不足**："同意救援"按钮禁用

## 配置参数

在`GraveRescueManager`中：
- `RESCUE_RANGE = 100.0`：救援范围
- `RESCUE_TIME = 5.0`：读条时间

在救援界面中：
- 费用固定为 **1个Master Key**

## 注意事项

1. Ghost不保存玩家的属性数据（HP、攻击力等），仅保存职业外观和武器配置
2. Ghost的武器等级与玩家死亡时的武器等级一致
3. 救援的Ghost会插入队伍末尾，按顺序跟随
4. 墓碑和救援管理器会随场景一起清理，不会跨场景残留
5. 每次死亡只会有一个墓碑存在（旧墓碑会被清除）

## 调试日志

系统会输出以下关键日志：
- `[DeathManager] 创建Ghost数据 | 职业: ... 武器数: ...`
- `[DeathManager] 救援管理器已创建`
- `[GraveRescue] 进入/离开救援范围`
- `[GraveRescue] 开始/停止读条`
- `[GraveRescue] 读条完成，显示救援界面`
- `[GraveRescue] 执行救援/超度`
- `[GraveRescue] Ghost创建成功！职业: ... 武器数: ...`

---

**实现完成时间**：2025-11-01  
**版本**：1.0

