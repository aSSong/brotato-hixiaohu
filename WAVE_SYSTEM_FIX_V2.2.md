# æ³¢æ¬¡ç³»ç»Ÿä¿®å¤ v2.2 - é˜²æ­¢å•†åº—æœŸé—´å¼€å§‹æ–°æ³¢æ¬¡

## é—®é¢˜åˆ†æï¼ˆä»æˆªå›¾ï¼‰

### è§‚å¯Ÿåˆ°çš„é—®é¢˜
1. âŒ Waveæ˜¾ç¤ºç¬¬2æ³¢ï¼ˆWave: 2 (0/10)ï¼‰
2. âŒ å‡çº§å•†åº—è¿˜åœ¨æ˜¾ç¤º
3. âŒ åœºä¸Šæœ‰æ–°æ³¢æ¬¡çš„æ•Œäººåœ¨ç”Ÿæˆ
4. âœ… æ—¥å¿—æ˜¾ç¤ºå‡»æ€é€»è¾‘æ­£ç¡®ï¼ˆ10/10, å­˜æ´»:0ï¼‰

### æ ¹æœ¬åŸå› 
`_end_current_wave()` æ˜¯å¼‚æ­¥å‡½æ•°ï¼Œä½¿ç”¨äº† `await`ï¼š
```gdscript
func _end_current_wave() -> void:
    is_wave_in_progress = false  // ç«‹å³è®¾ä¸ºfalse
    await _show_upgrade_shop()   // ç­‰å¾…å•†åº—
    await shop_closed             // ç­‰å¾…å…³é—­
    start_next_wave()             // å¼€å§‹ä¸‹ä¸€æ³¢
```

**é—®é¢˜**ï¼š
- `is_wave_in_progress` åœ¨å•†åº—æ‰“å¼€å‰å°±è®¾ä¸º `false`
- å•†åº—è¿˜åœ¨æ˜¾ç¤ºæ—¶ï¼ŒæŸäº›åœ°æ–¹å¯èƒ½è°ƒç”¨äº† `start_next_wave()`
- å¯¼è‡´æ–°æ³¢æ¬¡åœ¨å•†åº—è¿˜å¼€ç€æ—¶å°±å¼€å§‹äº†

## è§£å†³æ–¹æ¡ˆ

### 1. æ·»åŠ åŒé‡é˜²æŠ¤åˆ° `start_next_wave()`
```gdscript
func start_next_wave() -> void:
    // é˜²æŠ¤1: æ£€æŸ¥å•†åº—çŠ¶æ€
    if is_shop_open:
        push_warning("å•†åº—è¿˜åœ¨å¼€ç€ï¼Œä¸èƒ½å¼€å§‹æ–°æ³¢æ¬¡ï¼")
        return
    
    // é˜²æŠ¤2: æ£€æŸ¥æ³¢æ¬¡çŠ¶æ€
    if is_wave_in_progress:
        push_warning("å·²æœ‰æ³¢æ¬¡åœ¨è¿›è¡Œï¼Œä¸èƒ½å¼€å§‹æ–°æ³¢æ¬¡ï¼")
        return
    
    // ç»§ç»­å¼€å§‹æ–°æ³¢æ¬¡...
```

### 2. æ”¹è¿› `_end_current_wave()` çš„çŠ¶æ€ç®¡ç†
```gdscript
func _end_current_wave() -> void:
    is_wave_in_progress = false
    is_shop_open = true  // ç«‹å³æ ‡è®°å•†åº—æ‰“å¼€
    
    // æš‚åœæ¸¸æˆ
    get_tree().paused = true
    
    // ç­‰å¾…å•†åº—æ‰“å¼€å’Œå…³é—­
    await _show_upgrade_shop()
    await shop_closed
    
    // å•†åº—å…³é—­å
    is_shop_open = false  // æ¸…é™¤å•†åº—æ ‡è®°
    
    // ç¡®ä¿æ¸¸æˆæ¢å¤
    if get_tree().paused:
        get_tree().paused = false
    
    // å»¶è¿Ÿ1ç§’å†å¼€å§‹ä¸‹ä¸€æ³¢
    await get_tree().create_timer(1.0).timeout
    
    start_next_wave()
```

### 3. æš‚åœæ¸¸æˆ
åœ¨å•†åº—æ‰“å¼€å‰æš‚åœæ¸¸æˆï¼Œé˜²æ­¢ï¼š
- æ•Œäººç»§ç»­ç§»åŠ¨/æ”»å‡»
- æ­¦å™¨ç»§ç»­æ”»å‡»
- ä»»ä½•å¼‚æ­¥é€»è¾‘ç»§ç»­æ‰§è¡Œ

## å…³é”®æ”¹è¿›

### âœ… é˜²æŠ¤1ï¼šå•†åº—çŠ¶æ€æ£€æŸ¥
```gdscript
if is_shop_open:
    return  // å•†åº—å¼€ç€ä¸èƒ½å¼€å§‹æ–°æ³¢æ¬¡
```

### âœ… é˜²æŠ¤2ï¼šæ³¢æ¬¡çŠ¶æ€æ£€æŸ¥
```gdscript
if is_wave_in_progress:
    return  // æœ‰æ³¢æ¬¡è¿›è¡Œä¸­ä¸èƒ½å¼€å§‹æ–°æ³¢æ¬¡
```

### âœ… æ”¹è¿›3ï¼šæ¸¸æˆæš‚åœ
```gdscript
get_tree().paused = true  // å•†åº—æ‰“å¼€å‰æš‚åœ
// å•†åº—å…³é—­åæ¢å¤
get_tree().paused = false
```

### âœ… æ”¹è¿›4ï¼šå»¶è¿Ÿå¼€å§‹
```gdscript
await get_tree().create_timer(1.0).timeout  // å»¶è¿Ÿ1ç§’
start_next_wave()
```

## å®Œæ•´æµç¨‹

```
å‡»æ€æœ€åæ•Œäºº
    â†“
on_enemy_killed() æ£€æµ‹åˆ° enemies_killed=10, enemies_alive=0
    â†“
è°ƒç”¨ _end_current_wave()
    â†“
is_wave_in_progress = false
is_shop_open = true  â† ç«‹å³æ ‡è®°ï¼
    â†“
æš‚åœæ¸¸æˆ (paused = true)
    â†“
æ‰“å¼€å•†åº—
    â†“
ã€ç©å®¶é€‰æ‹©å‡çº§ã€‘
    â†“
å…³é—­å•†åº—ï¼Œå‘å‡º shop_closed ä¿¡å·
    â†“
is_shop_open = false
æ¢å¤æ¸¸æˆ (paused = false)
    â†“
ç­‰å¾…1ç§’
    â†“
start_next_wave() æ£€æŸ¥ï¼š
  - is_shop_open? NO âœ“
  - is_wave_in_progress? NO âœ“
    â†“
å¼€å§‹ç¬¬2æ³¢
```

## é˜²æŠ¤çŸ©é˜µ

| æ—¶æœº | is_wave_in_progress | is_shop_open | paused | èƒ½å¼€å§‹æ–°æ³¢æ¬¡? |
|------|-------------------|-------------|--------|-------------|
| ç¬¬1æ³¢è¿›è¡Œä¸­ | true | false | false | âŒ NO |
| ç¬¬1æ³¢ç»“æŸï¼Œå•†åº—æ‰“å¼€å‰ | false | true | true | âŒ NO |
| å•†åº—æ˜¾ç¤ºä¸­ | false | true | true | âŒ NO |
| å•†åº—å…³é—­ï¼Œå»¶è¿Ÿä¸­ | false | false | false | âŒ NO (ç­‰å¾…) |
| å»¶è¿Ÿç»“æŸ | false | false | false | âœ… YES |

## æµ‹è¯•éªŒè¯

### åº”è¯¥çœ‹åˆ°çš„æ—¥å¿—
```
æ•Œäººå‡»æ€: 10/10 (å·²ç”Ÿæˆ:10 å­˜æ´»:0)
æ³¢æ¬¡ç»“æŸæ¡ä»¶æ»¡è¶³ï¼
=== ç¬¬ 1 æ³¢ç»“æŸ ===
å‡»æ€: 10/10
å·²ç”Ÿæˆ: 10 å­˜æ´»: 0
å‡†å¤‡æ‰“å¼€å•†åº—...
æš‚åœæ¸¸æˆ
æ‰¾åˆ°å‡çº§å•†åº—ï¼Œæ­£åœ¨æ‰“å¼€...
ç­‰å¾…å•†åº—å…³é—­...
ã€ç©å®¶æ“ä½œå•†åº—ã€‘
æ”¶åˆ°å•†åº—å…³é—­ä¿¡å·
å•†åº—å·²å…³é—­ï¼Œå‡†å¤‡å¼€å§‹ä¸‹ä¸€æ³¢...
æ¢å¤æ¸¸æˆ
ã€ç­‰å¾…1ç§’ã€‘
å‡†å¤‡å¼€å§‹ä¸‹ä¸€æ³¢...
=== å¼€å§‹ç¬¬ 2 æ³¢ ===
```

### é¢„æœŸæ•ˆæœ
1. âœ… å•†åº—æ˜¾ç¤ºæ—¶ï¼Œæ¸¸æˆæš‚åœ
2. âœ… å•†åº—æ˜¾ç¤ºæ—¶ï¼Œæ²¡æœ‰æ–°æ•Œäººç”Ÿæˆ
3. âœ… å•†åº—æ˜¾ç¤ºæ—¶ï¼ŒWaveæ˜¾ç¤ºä»ä¸ºç¬¬1æ³¢
4. âœ… å…³é—­å•†åº—åï¼Œå»¶è¿Ÿ1ç§’æ‰å¼€å§‹ç¬¬2æ³¢
5. âœ… ç¬¬2æ³¢å¼€å§‹æ—¶ï¼ŒWaveæ›´æ–°ä¸º2ï¼Œå¼€å§‹ç”Ÿæˆæ•Œäºº

## ä¿®æ”¹çš„æ–‡ä»¶

- **Scripts/enemies/wave_manager.gd**
  - `start_next_wave()`: æ·»åŠ 2ä¸ªé˜²æŠ¤æ£€æŸ¥
  - `_end_current_wave()`: æ”¹è¿›çŠ¶æ€ç®¡ç†ï¼Œæ·»åŠ æ¸¸æˆæš‚åœ/æ¢å¤

## ç‰ˆæœ¬å¯¹æ¯”

| åŠŸèƒ½ | v2.1 | v2.2 (å½“å‰) |
|------|------|------------|
| å•†åº—çŠ¶æ€æ£€æŸ¥ | âŒ æ—  | âœ… æœ‰ |
| æ³¢æ¬¡çŠ¶æ€æ£€æŸ¥ | âŒ æ—  | âœ… æœ‰ |
| æ¸¸æˆæš‚åœ | âŒ ä»…å•†åº—å†… | âœ… wave_managerä¹Ÿæ§åˆ¶ |
| å»¶è¿Ÿå¼€å§‹ | 0.5ç§’ | 1.0ç§’ |
| é˜²æŠ¤çº§åˆ« | å¼± | å¼º |

ç°åœ¨æ³¢æ¬¡ç³»ç»Ÿåº”è¯¥å®Œå…¨ç¨³å®šï¼Œä¸ä¼šå‡ºç°å•†åº—æœŸé—´å¼€å§‹æ–°æ³¢æ¬¡çš„é—®é¢˜äº†ï¼ğŸ‰

