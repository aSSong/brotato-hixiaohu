# æ³¢æ¬¡ç³»ç»Ÿä¿®å¤ v2.3 - ä½¿ç”¨å®é™…åœºä¸Šæ•Œäººæ•°é‡åˆ¤æ–­

## é—®é¢˜åˆ†æï¼ˆä»æˆªå›¾ï¼‰

### æ ¸å¿ƒé—®é¢˜
å•†åº—æ‰“å¼€æ—¶åœºä¸Šè¿˜æœ‰æ•Œäººå­˜æ´»ï¼ˆå·¦ä¸‹è§’å¯è§ç´«è‰²æ•Œäººï¼‰

### æ ¹æœ¬åŸå› 
**æ•Œäººè®¡æ•°ä¸å‡†ç¡®ï¼**

1. âŒ `enemies_alive_this_wave` ä¾èµ–äº `on_enemy_spawned()` å’Œ `on_enemy_killed()` çš„è°ƒç”¨æ¥å¢å‡
2. âŒ å¦‚æœæœ‰ä»»ä½•æƒ…å†µå¯¼è‡´è¿™ä¸¤ä¸ªå‡½æ•°è°ƒç”¨ä¸åŒ¹é…ï¼ˆæ¯”å¦‚Ghostå‡»æ€æ•Œäººã€æ•Œäººç”Ÿæˆå¤±è´¥ç­‰ï¼‰ï¼Œè®¡æ•°å°±ä¼šä¸å‡†
3. âŒ ä½¿ç”¨ä¸å‡†ç¡®çš„è®¡æ•°åˆ¤æ–­æ³¢æ¬¡ç»“æŸï¼Œå¯¼è‡´å•†åº—åœ¨åœºä¸Šè¿˜æœ‰æ•Œäººæ—¶å°±æ‰“å¼€

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä½¿ç”¨å®æ—¶åœºä¸Šæ•Œäººæ•°é‡ï¼ˆæ¨èï¼‰âœ…

```gdscript
# ä¸ä¾èµ–è®¡æ•°ï¼Œç›´æ¥æŸ¥è¯¢åœºä¸Šæœ‰å¤šå°‘æ•Œäºº
var actual_enemy_count = get_tree().get_nodes_in_group("enemy").size()

if enemies_killed_this_wave >= enemies_total_this_wave:
    if actual_enemy_count <= 0:  // æ£€æŸ¥çœŸå®æ•Œäººæ•°
        _end_current_wave()
    else:
        print("åœºä¸Šè¿˜æœ‰æ•Œäººï¼Œç­‰å¾…...")
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä¸ä¾èµ–è®¡æ•°å‡†ç¡®æ€§
- âœ… ç›´æ¥æŸ¥è¯¢åœºä¸Šå®é™…æƒ…å†µ
- âœ… ä¸å—Ghostã€ç”Ÿæˆå¤±è´¥ç­‰å› ç´ å½±å“
- âœ… æœ€å¯é çš„åˆ¤æ–­æ–¹å¼

### æ–¹æ¡ˆ2: ä¿®å¤è®¡æ•°é€»è¾‘ï¼ˆå¤‡é€‰ï¼‰

æ£€æŸ¥æ‰€æœ‰å¯èƒ½å½±å“è®¡æ•°çš„åœ°æ–¹ï¼š
- Ghostå‡»æ€æ•Œäººæ˜¯å¦è®¡å…¥
- æ•Œäººç”Ÿæˆå¤±è´¥æ˜¯å¦æ­£ç¡®å¤„ç†
- æ•Œäººè¢«å…¶ä»–æ–¹å¼æ€æ­»çš„æƒ…å†µ

**ç¼ºç‚¹**ï¼š
- âŒ éœ€è¦è¿½è¸ªæ‰€æœ‰å¯èƒ½çš„è¾¹ç•Œæƒ…å†µ
- âŒ å®¹æ˜“é—æ¼æŸäº›æƒ…å†µ
- âŒ ç»´æŠ¤æˆæœ¬é«˜

## å®ç°ç»†èŠ‚

### 1. ç¡®ä¿æ•ŒäººåŠ å…¥ "enemy" ç»„

```gdscript
# Scripts/enemies/enemy.gd
func _ready() -> void:
    add_to_group("enemy")  # å…³é”®ï¼
    # ...
```

**ä¸ºä»€ä¹ˆé‡è¦**ï¼š
- `get_tree().get_nodes_in_group("enemy")` éœ€è¦æ•Œäººåœ¨è¿™ä¸ªç»„é‡Œ
- è¿™æ˜¯å”¯ä¸€èƒ½å‡†ç¡®è·å–åœºä¸Šæ•Œäººæ•°é‡çš„æ–¹å¼

### 2. ä¿®æ”¹æ³¢æ¬¡ç»“æŸåˆ¤å®š

```gdscript
# Scripts/enemies/wave_manager.gd
func on_enemy_killed() -> void:
    # ...
    
    # å®æ—¶æŸ¥è¯¢åœºä¸ŠçœŸå®çš„æ•Œäººæ•°é‡
    var actual_enemy_count = get_tree().get_nodes_in_group("enemy").size()
    
    print("æ•Œäººå‡»æ€: ", enemies_killed_this_wave, "/", enemies_total_this_wave, 
          " (å·²ç”Ÿæˆ:", enemies_spawned_this_wave, 
          " å­˜æ´»è®¡æ•°:", enemies_alive_this_wave, 
          " å®é™…åœºä¸Š:", actual_enemy_count, ")")
    
    # æ–°çš„åˆ¤å®šé€»è¾‘
    if enemies_killed_this_wave >= enemies_total_this_wave:
        # å‡»æ€æ•°è¾¾æ ‡åï¼Œæ£€æŸ¥åœºä¸Šæ˜¯å¦è¿˜æœ‰æ•Œäºº
        if actual_enemy_count <= 0:
            print("æ³¢æ¬¡ç»“æŸæ¡ä»¶æ»¡è¶³ï¼")
            _end_current_wave()
        else:
            print("å‡»æ€æ•°è¾¾æ ‡ä½†åœºä¸Šè¿˜æœ‰", actual_enemy_count, "ä¸ªæ•Œäººï¼Œç­‰å¾…å‡»æ€å®Œæ¯•...")
```

## å¯¹æ¯”ï¼šæ—§é€»è¾‘ vs æ–°é€»è¾‘

### æ—§é€»è¾‘ï¼ˆæœ‰é—®é¢˜ï¼‰âŒ
```gdscript
if enemies_killed_this_wave >= 10 and enemies_alive_this_wave <= 0:
    _end_current_wave()
```

**é—®é¢˜**ï¼š
- å¦‚æœ `enemies_alive_this_wave` è®¡æ•°é”™è¯¯ï¼ˆæ¯”å¦‚Ghostæ€äº†1ä¸ªæ•Œäººä½†è®¡æ•°æœªå‡ï¼‰
- å®é™…åœºä¸Šæœ‰1ä¸ªæ•Œäººï¼Œä½† `enemies_alive_this_wave = 0`
- ç»“æœï¼šå‡»æ€9ä¸ªåå°±åˆ¤å®šæ³¢æ¬¡ç»“æŸï¼Œå•†åº—æ‰“å¼€ï¼Œåœºä¸Šè¿˜æœ‰1ä¸ªæ•Œäºº

### æ–°é€»è¾‘ï¼ˆæ­£ç¡®ï¼‰âœ…
```gdscript
var actual_enemy_count = get_tree().get_nodes_in_group("enemy").size()

if enemies_killed_this_wave >= 10:
    if actual_enemy_count <= 0:
        _end_current_wave()
    else:
        print("åœºä¸Šè¿˜æœ‰", actual_enemy_count, "ä¸ªæ•Œäºº")
```

**ä¼˜åŠ¿**ï¼š
- ç›´æ¥æŸ¥è¯¢åœºä¸Šå®é™…æœ‰å¤šå°‘æ•Œäºº
- ä¸ä¾èµ–ä»»ä½•è®¡æ•°å˜é‡
- 100% å‡†ç¡®

## è°ƒè¯•æ—¥å¿—æ”¹è¿›

### æ–°çš„æ—¥å¿—è¾“å‡º
```
æ•Œäººå‡»æ€: 9/10 (å·²ç”Ÿæˆ:10 å­˜æ´»è®¡æ•°:1 å®é™…åœºä¸Š:1)
æ•Œäººå‡»æ€: 10/10 (å·²ç”Ÿæˆ:10 å­˜æ´»è®¡æ•°:0 å®é™…åœºä¸Š:1)  â† å‘ç°ä¸ä¸€è‡´ï¼
å‡»æ€æ•°è¾¾æ ‡ä½†åœºä¸Šè¿˜æœ‰ 1 ä¸ªæ•Œäººï¼Œç­‰å¾…å‡»æ€å®Œæ¯•...
æ•Œäººå‡»æ€: 11/10 (å·²ç”Ÿæˆ:10 å­˜æ´»è®¡æ•°:-1 å®é™…åœºä¸Š:0)  â† æœ€åä¸€ä¸ªä¹Ÿè¢«æ€äº†
æ³¢æ¬¡ç»“æŸæ¡ä»¶æ»¡è¶³ï¼(å‡»æ€æ•°è¾¾æ ‡ä¸”åœºä¸Šæ— å­˜æ´»æ•Œäºº)
```

### å…³é”®ä¿¡æ¯
- **å­˜æ´»è®¡æ•°**ï¼š`enemies_alive_this_wave`ï¼ˆå¯èƒ½ä¸å‡†ï¼‰
- **å®é™…åœºä¸Š**ï¼š`get_tree().get_nodes_in_group("enemy").size()`ï¼ˆ100%å‡†ç¡®ï¼‰
- å¦‚æœä¸¤è€…ä¸ä¸€è‡´ï¼Œè¯´æ˜è®¡æ•°æœ‰bugï¼Œä½†ä¸å½±å“åˆ¤æ–­

## å¯èƒ½çš„è®¡æ•°ä¸å‡†åŸå› 

### 1. Ghostæ­¦å™¨å‡»æ€æ•Œäºº
- Ghostçš„æ­¦å™¨æ”»å‡»æ•Œäºº
- æ•Œäººæ­»äº¡ï¼Œå‘å‡º `enemy_killed` ä¿¡å·
- `on_enemy_killed()` è¢«å¤šæ¬¡è°ƒç”¨
- ä½† `on_enemy_spawned()` æ²¡æœ‰ä¸ºGhostè°ƒç”¨
- **ç»“æœ**ï¼šå‡»æ€æ•° > ç”Ÿæˆæ•°

### 2. æ•Œäººç”Ÿæˆå¤±è´¥ä½†è¢«æ‰‹åŠ¨æ·»åŠ 
- `spawn_enemy()` å¤±è´¥ï¼Œæ²¡è°ƒç”¨ `on_enemy_spawned()`
- ä½†åç»­æŸä¸ªæµç¨‹æ‰‹åŠ¨æ·»åŠ äº†æ•Œäºº
- **ç»“æœ**ï¼šåœºä¸Šæœ‰æ•Œäººä½†è®¡æ•°ä¸º0

### 3. æ•Œäººè¢«å…¶ä»–æ–¹å¼ç§»é™¤
- æ•Œäººè¢« `queue_free()` ä½†æ²¡è§¦å‘ `enemy_killed` ä¿¡å·
- **ç»“æœ**ï¼šè®¡æ•°å‡å°‘ä½†æ²¡è°ƒç”¨ `on_enemy_killed()`

## é¢„æœŸæ•ˆæœ

### âœ… ç°åœ¨åº”è¯¥çœ‹åˆ°
1. å•†åº—åªåœ¨åœºä¸Šæœ€åä¸€ä¸ªæ•Œäººè¢«æ€æ­»åæ‰æ‰“å¼€
2. æ—¥å¿—æ¸…æ¥šæ˜¾ç¤º "å®é™…åœºä¸Š" çš„æ•Œäººæ•°é‡
3. å³ä½¿ "å­˜æ´»è®¡æ•°" ä¸å‡†ï¼Œä¹Ÿèƒ½æ­£ç¡®åˆ¤æ–­æ³¢æ¬¡ç»“æŸ
4. ä¸å†å‡ºç°å•†åº—å¼€ç€æ—¶åœºä¸Šæœ‰æ•Œäººçš„æƒ…å†µ

### ğŸ“Š æµ‹è¯•åœºæ™¯
```
å‡»æ€ç¬¬9ä¸ªæ•Œäºº â†’ åœºä¸Šè¿˜æœ‰1ä¸ª â†’ ä¸å¼€å•†åº— âœ“
å‡»æ€ç¬¬10ä¸ªæ•Œäºº â†’ åœºä¸Šè¿˜æœ‰1ä¸ª(Ghostæ€çš„) â†’ ä¸å¼€å•†åº— âœ“
Ghostæ€æ­»æœ€å1ä¸ª â†’ åœºä¸Š0ä¸ª â†’ å¼€å•†åº— âœ“
```

## ä¿®æ”¹çš„æ–‡ä»¶

1. **Scripts/enemies/enemy.gd**
   - `_ready()`: æ·»åŠ  `add_to_group("enemy")`

2. **Scripts/enemies/wave_manager.gd**
   - `on_enemy_killed()`: 
     - æ·»åŠ å®æ—¶æŸ¥è¯¢ `actual_enemy_count`
     - ä¿®æ”¹åˆ¤å®šé€»è¾‘ä½¿ç”¨ `actual_enemy_count`
     - æ”¹è¿›æ—¥å¿—è¾“å‡º

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | åˆ¤å®šæ–¹å¼ | é—®é¢˜ |
|------|---------|------|
| v2.1 | `enemies_alive_this_wave <= 0` | è®¡æ•°ä¸å‡†å¯¼è‡´è¯¯åˆ¤ âŒ |
| v2.2 | æ·»åŠ é˜²æŠ¤æ£€æŸ¥ | é˜²æ­¢å•†åº—æœŸé—´å¼€å§‹æ–°æ³¢ âœ… |
| v2.3 | `actual_enemy_count <= 0` | ä½¿ç”¨å®é™…æ•Œäººæ•°ï¼Œ100%å‡†ç¡® âœ… |

ç°åœ¨æ³¢æ¬¡ç³»ç»Ÿåº”è¯¥å®Œå…¨å‡†ç¡®äº†ï¼ğŸ¯

