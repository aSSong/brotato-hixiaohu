# 波次系统修复说明 (v2.1 - 最终版)

## 核心修复

### 🎯 关键问题定位

**问题**: 商店弹出时场上还有存活的怪物

**根本原因**: 
- 之前的逻辑要求"击杀数达标 AND 全部生成 AND 场上无敌人"三个条件同时满足
- 但由于敌人生成是异步的（每0.5秒生成一个），击杀速度可能比生成速度快
- 导致击杀数达标时，还有敌人正在生成过程中或已经生成但还没被击杀

### ✅ 正确的波次结束逻辑

波次应该在以下情况下结束：
1. ✅ **击杀数达到目标** (enemies_killed >= enemies_total)
2. ✅ **场上没有存活的敌人** (enemies_alive <= 0)

**不需要检查**"是否全部生成"，因为：
- 生成失败的敌人不应该阻止波次结束
- 关键是场上要没有活着的敌人

## 修改详情

### 修改1: 简化 `on_enemy_spawned()`
```gdscript
func on_enemy_spawned() -> void:
    enemies_spawned_this_wave += 1
    enemies_alive_this_wave += 1
    print("敌人生成: ", enemies_spawned_this_wave, "/", enemies_total_this_wave, " (存活:", enemies_alive_this_wave, ")")
    # 不在这里检查波次结束！
```

### 修改2: 改进 `on_enemy_killed()`
```gdscript
func on_enemy_killed() -> void:
    enemies_killed_this_wave += 1
    enemies_alive_this_wave -= 1
    
    # 只检查两个条件：
    # 1. 击杀数达标
    # 2. 场上无敌人
    if enemies_killed >= enemies_total and enemies_alive <= 0:
        _end_current_wave()  # 立即结束波次！
```

## 波次流程示例

### 正常流程
```
第1波开始 (目标:10个敌人)
-----------------
生成敌人1 -> 存活:1
生成敌人2 -> 存活:2
击杀敌人1 -> 击杀:1, 存活:1
生成敌人3 -> 存活:2
击杀敌人2 -> 击杀:2, 存活:1
... (继续生成和击杀)
击杀敌人9 -> 击杀:9, 存活:1
生成敌人10 -> 存活:2
击杀敌人10 -> 击杀:10, 存活:1 (击杀数达标但还有敌人存活)
... (继续战斗)
击杀最后敌人 -> 击杀:11, 存活:0 ✅ 波次结束！弹出商店
```

### 快速击杀流程
```
第1波开始 (目标:10个敌人)
-----------------
生成敌人1 -> 存活:1
生成敌人2 -> 存活:2
生成敌人3 -> 存活:3
击杀所有3个 -> 击杀:3, 存活:0 (还没达到目标，继续生成)
生成敌人4 -> 存活:1
... (继续)
击杀敌人10 -> 击杀:10, 存活:0 ✅ 波次结束！弹出商店
```

## 关键保证

### ✅ 保证1: 商店弹出时场上无敌人
只有当 `enemies_alive <= 0` 时才会调用 `_end_current_wave()`，因此商店弹出时一定没有敌人。

### ✅ 保证2: 波次生成完整性
每波开始时：
1. 发出 `wave_started` 信号
2. `now_enemies.gd` 开始异步生成敌人
3. 生成过程中可以击杀敌人
4. 只要击杀数达标且场上无敌人，立即结束波次

### ✅ 保证3: 不会提前开始下一波
`_end_current_wave()` 会：
1. 设置 `is_wave_in_progress = false`
2. 弹出商店并等待关闭
3. 只有商店关闭后才调用 `start_next_wave()`

## 测试检查点

### ✅ 测试1: 正常击杀
1. 开始第1波
2. 逐个击杀敌人
3. 击杀最后一个敌人时，商店应该立即弹出
4. 此时场上应该没有任何敌人

### ✅ 测试2: 快速击杀
1. 开始第1波
2. 快速击杀前几个敌人（可能后面还在生成）
3. 继续战斗直到击杀数达标
4. 击杀最后一个敌人时，商店弹出

### ✅ 测试3: Ghost协助
1. 创建几个Ghost
2. 让Ghost协助击杀敌人
3. Ghost击杀也计入击杀数
4. 击杀数达标且场上无敌人时，正常结束波次

### ✅ 测试4: 计数准确性
观察控制台输出：
```
敌人击杀: 9/10 (已生成:10 存活:1)  <- 还有1个敌人
敌人击杀: 10/10 (已生成:10 存活:0) <- 击杀最后一个
波次结束条件满足！(击杀数达标且场上无存活敌人)
=== 第 1 波结束 ===
```

## 与v2.0的区别

| 项目 | v2.0 | v2.1 (当前版本) |
|------|------|----------------|
| 波次结束条件 | 3个条件 | 2个条件 |
| 检查位置 | 2个函数都检查 | 只在killed中检查 |
| 生成完整性 | 必须全部生成 | 不强制要求 |
| 响应速度 | 可能延迟 | 立即响应 |
| 边缘情况处理 | 可能卡住 | 有警告提示 |

## 修改的文件

1. **Scripts/enemies/wave_manager.gd**
   - 简化 `on_enemy_spawned()` - 移除波次结束检查
   - 改进 `on_enemy_killed()` - 只检查2个条件
   - 添加边缘情况处理（生成失败警告）

## 控制台输出示例

```
=== 开始第 1 波 ===
目标击杀数: 10
当前击杀: 0, 已生成: 0, 存活: 0
成功生成敌人: basic 位置: (956, 734)
敌人生成: 1/10 (存活:1)
成功生成敌人: basic 位置: (1245, 456)
敌人生成: 2/10 (存活:2)
敌人击杀: 1/10 (已生成:2 存活:1)
成功生成敌人: fast 位置: (789, 612)
敌人生成: 3/10 (存活:2)
...
敌人击杀: 9/10 (已生成:10 存活:1)
敌人击杀: 10/10 (已生成:10 存活:0)
波次结束条件满足！(击杀数达标且场上无存活敌人)
=== 第 1 波结束 ===
击杀: 10/10
已生成: 10 存活: 0
```

## 预期效果

✅ **商店弹出时机准确**: 必定是场上最后一个敌人被击杀时  
✅ **没有残留敌人**: 商店弹出时场上一定没有敌人  
✅ **波次生成不重复**: 每波只生成一次  
✅ **计数准确**: 击杀数/总数始终正确  
✅ **响应速度快**: 击杀最后敌人立即弹出商店  

现在波次系统应该完全符合预期了！🎉

