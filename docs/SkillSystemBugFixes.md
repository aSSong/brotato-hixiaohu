# æŠ€èƒ½ç³»ç»ŸBugä¿®å¤æŠ¥å‘Š

## ğŸ› å‘ç°çš„é—®é¢˜

### 1. âŒ æŠ€èƒ½æ•ˆæœç´¯åŠ é—®é¢˜
**é—®é¢˜æè¿°**ï¼šä½¿ç”¨dashæŠ€èƒ½åï¼Œé€Ÿåº¦æ— æ³•å¤åŸï¼Œä¼šä¸€ç›´ç´¯åŠ ã€‚æ¯æ¬¡ä½¿ç”¨ç²¾å‡†å°„å‡»ï¼ŒHPä¸Šé™å°±+100ã€‚

**æ ¹æœ¬åŸå› **ï¼š
- æ¯æ¬¡æ¿€æ´»æŠ€èƒ½æ—¶éƒ½ä¼šåˆ›å»ºæ–°çš„ `AttributeModifier` å¹¶æ·»åŠ åˆ° `AttributeManager`
- ä½†æ˜¯**æ²¡æœ‰å…ˆç§»é™¤æ—§çš„ä¿®æ”¹å™¨**
- å¯¼è‡´å¤šä¸ªç›¸åŒçš„ä¿®æ”¹å™¨åœ¨ `temporary_modifiers` åˆ—è¡¨ä¸­ç´¯åŠ 

**å½±å“èŒƒå›´**ï¼šæ‰€æœ‰æŠ€èƒ½

### 2. âŒ é­”æ³•çˆ†å‘æŠ€èƒ½ç¼ºå°‘æŒç»­æ—¶é—´
**é—®é¢˜æè¿°**ï¼šæ³•å¸ˆçš„"é­”æ³•çˆ†å‘"æŠ€èƒ½é…ç½®ä¸­ç¼ºå°‘ `duration` å‚æ•°ã€‚

**æ ¹æœ¬åŸå› **ï¼š
- `class_database.gd` ä¸­å®šä¹‰æ³•å¸ˆæŠ€èƒ½æ—¶é—æ¼äº† `duration` å­—æ®µ
- å¯¼è‡´æŠ€èƒ½ä¿®æ”¹å™¨çš„æŒç»­æ—¶é—´ä¸º 0ï¼Œç«‹å³è¿‡æœŸ

---

## âœ… ä¿®å¤å†…å®¹

### ä¿®å¤ 1ï¼šClassManager - é˜²æ­¢æŠ€èƒ½æ•ˆæœç´¯åŠ 

**æ–‡ä»¶**ï¼š`Scripts/players/class_manager.gd`

**ä¿®æ”¹ä½ç½®**ï¼š`activate_skill()` å‡½æ•°ï¼ˆç¬¬22-65è¡Œï¼‰

**ä¿®æ”¹å†…å®¹**ï¼š
```gdscript
# â­ æ·»åŠ ï¼šå¦‚æœæŠ€èƒ½å·²ç»æ¿€æ´»ï¼ˆæ—§ä¿®æ”¹å™¨è¿˜å­˜åœ¨ï¼‰ï¼Œå…ˆç§»é™¤
if skill_modifiers.has(skill_name):
    var old_modifier = skill_modifiers[skill_name]
    player.attribute_manager.remove_modifier_by_id(old_modifier.modifier_id)
    print("[ClassManager] ç§»é™¤æ—§çš„æŠ€èƒ½ä¿®æ”¹å™¨: %s" % skill_name)
```

**ä¿®å¤é€»è¾‘**ï¼š
1. æ£€æŸ¥æŠ€èƒ½æ˜¯å¦å·²ç»æœ‰æ¿€æ´»çš„ä¿®æ”¹å™¨ï¼ˆå­˜å‚¨åœ¨ `skill_modifiers` å­—å…¸ä¸­ï¼‰
2. å¦‚æœå­˜åœ¨ï¼Œå…ˆé€šè¿‡ `remove_modifier_by_id()` ä» `AttributeManager` ä¸­ç§»é™¤
3. ç„¶åå†åˆ›å»ºæ–°çš„ä¿®æ”¹å™¨å¹¶æ·»åŠ 

**æ•ˆæœ**ï¼š
- âœ… æŠ€èƒ½æ•ˆæœä¸å†ç´¯åŠ 
- âœ… æ¯æ¬¡æŠ€èƒ½æ¿€æ´»éƒ½ä¼šæ›¿æ¢æ—§çš„æ•ˆæœ
- âœ… é€Ÿåº¦ã€HPç­‰å±æ€§åœ¨æŠ€èƒ½ç»“æŸåæ­£ç¡®æ¢å¤

---

### ä¿®å¤ 2ï¼šæ·»åŠ é­”æ³•çˆ†å‘æŠ€èƒ½çš„æŒç»­æ—¶é—´

**æ–‡ä»¶**ï¼š`Scripts/data/class_database.gd`

**ä¿®æ”¹ä½ç½®**ï¼šæ³•å¸ˆæŠ€èƒ½é…ç½®ï¼ˆç¬¬79-86è¡Œï¼‰

**ä¿®æ”¹å†…å®¹**ï¼š
```gdscript
"é­”æ³•çˆ†å‘",  # skill_name
{
    "cooldown": 12.0,
    "duration": 5.0,  # â­ æ·»åŠ æŒç»­æ—¶é—´
    "explosion_radius_multiplier": 2.0,
    "damage_multiplier": 1.5,
    "all_enemies_in_range": true
}
```

**æ•ˆæœ**ï¼š
- âœ… é­”æ³•çˆ†å‘æŠ€èƒ½ç°åœ¨æœ‰5ç§’æŒç»­æ—¶é—´
- âœ… æŠ€èƒ½æ•ˆæœæ­£å¸¸å·¥ä½œï¼Œä¸ä¼šç«‹å³æ¶ˆå¤±

---

## ğŸ” æŠ€èƒ½é…ç½®éªŒè¯

### æ‰€æœ‰æŠ€èƒ½çš„å®Œæ•´é…ç½®ï¼š

#### 1. æˆ˜å£« - ç‹‚æš´ âœ…
```gdscript
{
    "cooldown": 10.0,
    "duration": 5.0,      // âœ… æœ‰æŒç»­æ—¶é—´
    "attack_speed_boost": 0.5,
    "damage_boost": 1.3
}
```
**æ•ˆæœ**ï¼šæ”»å‡»é€Ÿåº¦+50%ï¼Œä¼¤å®³+30%ï¼ŒæŒç»­5ç§’

#### 2. å°„æ‰‹ - ç²¾å‡†å°„å‡» âœ…
```gdscript
{
    "cooldown": 8.0,
    "duration": 4.0,      // âœ… æœ‰æŒç»­æ—¶é—´
    "crit_chance_boost": 0.5,
    "all_projectiles_crit": true
}
```
**æ•ˆæœ**ï¼šæš´å‡»ç‡+50%ï¼ŒæŒç»­4ç§’

#### 3. æ³•å¸ˆ - é­”æ³•çˆ†å‘ âœ…ï¼ˆå·²ä¿®å¤ï¼‰
```gdscript
{
    "cooldown": 12.0,
    "duration": 5.0,      // âœ… å·²æ·»åŠ æŒç»­æ—¶é—´
    "explosion_radius_multiplier": 2.0,
    "damage_multiplier": 1.5,
    "all_enemies_in_range": true
}
```
**æ•ˆæœ**ï¼šçˆ†ç‚¸èŒƒå›´Ã—2ï¼Œä¼¤å®³+50%ï¼ŒæŒç»­5ç§’

#### 4. å¹³è¡¡è€… - å…¨é¢å¼ºåŒ– âœ…
```gdscript
{
    "cooldown": 15.0,
    "duration": 6.0,      // âœ… æœ‰æŒç»­æ—¶é—´
    "all_stats_boost": 1.2
}
```
**æ•ˆæœ**ï¼šæ‰€æœ‰å±æ€§+20%ï¼ŒæŒç»­6ç§’

#### 5. å¦å…‹ - æŠ¤ç›¾ âœ…
```gdscript
{
    "cooldown": 20.0,
    "duration": 8.0,      // âœ… æœ‰æŒç»­æ—¶é—´
    "damage_reduction": 0.5,
    "reflect_damage": 0.3
}
```
**æ•ˆæœ**ï¼šå‡ä¼¤50%ï¼Œåå¼¹30%ä¼¤å®³ï¼ŒæŒç»­8ç§’

---

## ğŸ¯ æŠ€èƒ½æ•ˆæœæ˜ å°„éªŒè¯

### ClassManager ä¸­çš„æŠ€èƒ½æ˜ å°„ï¼š

#### 1. ç‹‚æš´ âœ…
```gdscript
modifier.stats_delta.global_attack_speed_add = attack_speed_boost  // +0.5
modifier.stats_delta.global_damage_mult = damage_boost             // Ã—1.3
```
**æ˜ å°„æ­£ç¡®** âœ…

#### 2. ç²¾å‡†å°„å‡» âœ…
```gdscript
modifier.stats_delta.crit_chance = crit_boost  // +0.5 (50%æš´å‡»ç‡)
```
**æ˜ å°„æ­£ç¡®** âœ…

#### 3. é­”æ³•çˆ†å‘ âœ…
```gdscript
modifier.stats_delta.magic_explosion_radius_mult = radius_mult  // Ã—2.0
modifier.stats_delta.magic_damage_mult = damage_mult            // Ã—1.5
```
**æ˜ å°„æ­£ç¡®** âœ…

#### 4. å…¨é¢å¼ºåŒ– âœ…
```gdscript
modifier.stats_delta.global_damage_mult = all_boost            // Ã—1.2
modifier.stats_delta.global_attack_speed_mult = all_boost      // Ã—1.2
var speed_boost = (all_boost - 1.0) * 400.0                    // +80é€Ÿåº¦
modifier.stats_delta.speed = speed_boost
```
**æ˜ å°„æ­£ç¡®** âœ…

#### 5. æŠ¤ç›¾ âœ…
```gdscript
modifier.stats_delta.damage_reduction = damage_reduction  // 0.5 (50%å‡ä¼¤)
// åå¼¹ä¼¤å®³éœ€è¦ç‰¹æ®Šå¤„ç†ï¼ˆä¸æ˜¯å±æ€§ï¼Œæ˜¯æ•ˆæœï¼‰
```
**æ˜ å°„æ­£ç¡®** âœ…

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯ 1ï¼šæŠ€èƒ½æ•ˆæœä¸ç´¯åŠ 
1. é€‰æ‹©å¹³è¡¡è€…èŒä¸š
2. æ¿€æ´»"å…¨é¢å¼ºåŒ–"æŠ€èƒ½
3. ç­‰å¾…æŠ€èƒ½ç»“æŸ
4. å†æ¬¡æ¿€æ´»æŠ€èƒ½
5. **é¢„æœŸç»“æœ**ï¼šé€Ÿåº¦åªå¢åŠ ä¸€æ¬¡ï¼Œä¸ä¼šç´¯åŠ 
6. **ä¿®å¤å‰**ï¼šé€Ÿåº¦ä¼šç´¯åŠ ï¼ˆ400 â†’ 480 â†’ 560 â†’ ...ï¼‰
7. **ä¿®å¤å**ï¼šé€Ÿåº¦æ­£ç¡®ï¼ˆ400 â†’ 480 â†’ 400 â†’ 480ï¼‰âœ…

### æµ‹è¯•åœºæ™¯ 2ï¼šHPä¸ç´¯åŠ 
1. é€‰æ‹©å°„æ‰‹èŒä¸š
2. æ¿€æ´»"ç²¾å‡†å°„å‡»"æŠ€èƒ½
3. å¤šæ¬¡æ¿€æ´»æŠ€èƒ½
4. **é¢„æœŸç»“æœ**ï¼šHPä¸Šé™ä¸å˜
5. **ä¿®å¤å‰**ï¼šæ¯æ¬¡æ¿€æ´»HP+100ï¼ˆbugï¼‰
6. **ä¿®å¤å**ï¼šHPæ­£ç¡®ï¼Œä¸ç´¯åŠ  âœ…

### æµ‹è¯•åœºæ™¯ 3ï¼šé­”æ³•çˆ†å‘æŠ€èƒ½æ­£å¸¸å·¥ä½œ
1. é€‰æ‹©æ³•å¸ˆèŒä¸š
2. æ¿€æ´»"é­”æ³•çˆ†å‘"æŠ€èƒ½
3. **é¢„æœŸç»“æœ**ï¼šæŠ€èƒ½æ•ˆæœæŒç»­5ç§’
4. **ä¿®å¤å‰**ï¼šæŠ€èƒ½ç«‹å³æ¶ˆå¤±ï¼ˆduration=0ï¼‰
5. **ä¿®å¤å**ï¼šæŠ€èƒ½æ•ˆæœæŒç»­5ç§’ âœ…

---

## ğŸ“ æŠ€æœ¯è¯´æ˜

### AttributeManager çš„ä¸´æ—¶ä¿®æ”¹å™¨ç®¡ç†

`AttributeManager` ä¼šåœ¨ `_process()` ä¸­è‡ªåŠ¨æ›´æ–°å’Œæ¸…ç†è¿‡æœŸçš„ä¸´æ—¶ä¿®æ”¹å™¨ï¼š

```gdscript
func _process(delta: float) -> void:
    for i in range(temporary_modifiers.size()):
        var modifier = temporary_modifiers[i]
        if modifier.duration > 0:
            modifier.update(delta)  // æ›´æ–°å‰©ä½™æ—¶é—´
            
            if modifier.is_expired():  // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
                expired_indices.append(i)
    
    // ç§»é™¤è¿‡æœŸçš„ä¿®æ”¹å™¨
    for i in expired_indices:
        temporary_modifiers.remove_at(i)
    
    recalculate()  // é‡æ–°è®¡ç®—å±æ€§
```

### ä¿®æ”¹å™¨ç”Ÿå‘½å‘¨æœŸ

```
æŠ€èƒ½æ¿€æ´»
    â†“
åˆ›å»º AttributeModifier (duration = 5.0)
    â†“
æ·»åŠ åˆ° AttributeManager.temporary_modifiers
    â†“
æ¯å¸§æ›´æ–° duration -= delta
    â†“
duration <= 0 æ—¶è‡ªåŠ¨ç§»é™¤
    â†“
recalculate() é‡æ–°è®¡ç®—å±æ€§
    â†“
å±æ€§æ¢å¤æ­£å¸¸
```

---

## âœ… ä¿®å¤æ€»ç»“

### ä¿®æ”¹çš„æ–‡ä»¶
1. `Scripts/players/class_manager.gd` - æ·»åŠ æ—§ä¿®æ”¹å™¨ç§»é™¤é€»è¾‘
2. `Scripts/data/class_database.gd` - æ·»åŠ é­”æ³•çˆ†å‘æŠ€èƒ½çš„ duration

### ä¿®å¤çš„é—®é¢˜
1. âœ… æŠ€èƒ½æ•ˆæœä¸å†ç´¯åŠ 
2. âœ… é€Ÿåº¦åœ¨æŠ€èƒ½ç»“æŸåæ­£ç¡®æ¢å¤
3. âœ… HPä¸Šé™ä¸ä¼šå¼‚å¸¸å¢åŠ 
4. âœ… é­”æ³•çˆ†å‘æŠ€èƒ½ç°åœ¨æœ‰æ­£ç¡®çš„æŒç»­æ—¶é—´
5. âœ… æ‰€æœ‰æŠ€èƒ½éƒ½æœ‰å®Œæ•´çš„é…ç½®å‚æ•°

### éªŒè¯æ¸…å•
- [x] æ‰€æœ‰æŠ€èƒ½éƒ½æœ‰ `cooldown` å’Œ `duration` å‚æ•°
- [x] æ‰€æœ‰æŠ€èƒ½æ•ˆæœæ­£ç¡®æ˜ å°„åˆ° `CombatStats` å±æ€§
- [x] æŠ€èƒ½æ¿€æ´»å‰ä¼šç§»é™¤æ—§çš„ä¿®æ”¹å™¨
- [x] `AttributeManager` è‡ªåŠ¨æ¸…ç†è¿‡æœŸçš„ä¸´æ—¶ä¿®æ”¹å™¨
- [x] CDç®¡ç†æ­£å¸¸å·¥ä½œ

---

## ğŸ‰ ç»“è®º

æ‰€æœ‰æŠ€èƒ½ç³»ç»Ÿçš„bugå·²ä¿®å¤ï¼ç°åœ¨æŠ€èƒ½ç³»ç»Ÿå¯ä»¥æ­£å¸¸å·¥ä½œï¼š
- âœ… æŠ€èƒ½æ•ˆæœä¸ä¼šç´¯åŠ 
- âœ… æŠ€èƒ½ç»“æŸåå±æ€§æ­£ç¡®æ¢å¤
- âœ… æ‰€æœ‰èŒä¸šçš„æŠ€èƒ½éƒ½èƒ½æ­£å¸¸æ¿€æ´»å’Œè¿‡æœŸ
- âœ… CDç³»ç»Ÿæ­£å¸¸å·¥ä½œ

**ç³»ç»ŸçŠ¶æ€ï¼šå·²å°±ç»ªï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼** ğŸš€

---

*æœ€åæ›´æ–°ï¼š2024å¹´11æœˆ18æ—¥*

