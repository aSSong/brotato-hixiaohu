# 敌人配置操作手册

本手册说明如何在新的预制场景系统下添加、修改和维护敌人配置。

---

## 目录结构

```
项目根目录/
├── scenes/enemies/
│   ├── enemy_base.tscn              # 基础模板（一般不需要修改）
│   └── prefabs/                     # 敌人预制场景
│       ├── creeper.tscn
│       ├── stapler.tscn
│       └── ...
│
├── resources/enemies/
│   ├── data/                        # 敌人数值配置（.tres）
│   │   ├── basic.tres
│   │   ├── stapler.tres
│   │   └── ...
│   └── animations/                  # 动画资源（SpriteFrames）
│       ├── creeper_sprites.tres
│       ├── stapler_sprites.tres
│       └── ...
│
└── assets/enemy/                    # 原始图片资源
    ├── creeper-run-Sheet.png
    ├── creeper-attack-Sheet.png     # 技能动画（如有）
    └── ...
```

---

## 一、添加新敌人（完整流程）

### 步骤 1：准备美术资源

1. 将敌人的 Sprite Sheet 放入 `assets/enemy/` 目录
2. 命名规范：`敌人名-动作-Sheet.png`，例如：
   - `goblin-run-Sheet.png` - 走路动画
   - `goblin-attack-Sheet.png` - 攻击动画
   - `goblin-hurt-Sheet.png` - 受伤动画

### 步骤 2：创建 SpriteFrames 资源

1. 在 FileSystem 中，右键 `resources/enemies/animations/`
2. 选择 **新建资源 → SpriteFrames**
3. 保存为 `敌人名_sprites.tres`（如 `goblin_sprites.tres`）

4. 双击打开 SpriteFrames 编辑器：
   - 点击 **+** 添加动画
   - 命名为 `walk`（必需的默认动画）
   - 点击 **从 Sprite Sheet 添加帧** 图标（网格图标）
   - 选择对应的 sprite sheet 图片
   - 配置切片参数：
     - **横向帧数** 和 **纵向帧数**
     - 或者手动设置 **帧宽/帧高**
   - 选择所有帧，点击 **添加帧**

5. 设置动画属性：
   - **速度 (FPS)**：动画播放速度
   - **循环**：勾选（走路动画应该循环）

6. 如有其他动画，重复上述步骤添加：
   - `attack` - 攻击动画
   - `hurt` - 受伤动画
   - `skill_prepare` - 技能准备动画
   - `skill_execute` - 技能执行动画

### 步骤 3：创建敌人预制场景

**方法 A：复制现有场景（推荐）**

1. 在 FileSystem 中，复制一个相似的敌人场景
2. 重命名为新敌人名（如 `goblin.tscn`）
3. 双击打开场景
4. 修改以下内容：
   - 选择 **AnimatedSprite2D** 节点
   - 在 Inspector 中，将 **Sprite Frames** 改为新创建的资源
   - 调整 **shadow** 节点的 position 和 scale
   - 调整 **CollisionShape2D** 的大小和位置

**方法 B：从模板创建**

1. 右键 `scenes/enemies/enemy_base.tscn`
2. 选择 **新建继承场景**
3. 保存到 `scenes/enemies/prefabs/goblin.tscn`
4. 配置各节点属性

**场景节点配置参考：**

| 节点 | 属性 | 说明 |
|-----|------|------|
| 根节点 | scale | 敌人整体大小，如 Vector2(0.4, 0.4) |
| shadow | position | 阴影位置偏移 |
| shadow | scale | 阴影大小 |
| AnimatedSprite2D | sprite_frames | 指向 SpriteFrames 资源 |
| AnimatedSprite2D | offset | 精灵偏移，通常 Vector2(0, -90) 到 Vector2(0, -150) |
| AnimatedSprite2D | autoplay | 设为 "walk" |
| CollisionShape2D | position | 碰撞体位置 |
| CollisionShape2D | shape.radius | 碰撞体大小 |

### 步骤 4：创建 EnemyData 资源

1. 在 FileSystem 中，右键 `resources/enemies/data/`
2. 选择 **新建资源 → 选择 EnemyData**（或复制现有 .tres 文件）
3. 保存为 `敌人ID.tres`（如 `goblin.tres`）

4. 在 Inspector 中配置：

```
enemy_name: "哥布林"
description: "弱小但数量众多的敌人"
scene_path: "res://scenes/enemies/prefabs/goblin.tscn"

# 数值属性
max_hp: 15
attack_damage: 4
move_speed: 350.0
attack_interval: 1.0
attack_range: 80.0

# AI 行为（默认近战追击，不填也行）
ai_type: MELEE
ai_config: {}

# 技能配置（无技能敌人）
skill_type: NONE
skill_config: {}

# 动画映射
animations: {
    "walk": "walk",
    "idle": "",
    "attack": "",
    "hurt": "",
    "skill_prepare": "",
    "skill_execute": ""
}

# 外观
scale: Vector2(0.4, 0.4)

# 死亡效果
shake_on_death: true
shake_duration: 0.2
shake_amount: 8.0
```

---

## 三、AI 行为类型（melee/ranged/escape/still）

本项目敌人的**基础碰撞攻击机制不变**：只要玩家距离 `< attack_range` 且冷却好了，就会触发触碰伤害（由 `enemy.gd` 处理）。\nAI 只影响“正常移动逻辑”（技能行为如冲锋/射击/自爆仍优先接管移动）。\n\n### 1) 字段说明\n\n在每个敌人的 `EnemyData(.tres)` 中配置：\n\n- `ai_type`：AI 类型枚举\n- `ai_config`：参数字典（不同类型用不同字段）\n\n### 2) 类型与参数\n\n#### a) 近战型：MELEE\n\n- **参数**：无（`ai_config` 留空即可）\n- **行为**：朝玩家移动，直至追击距离（与原逻辑一致：`attack_range - 20`）\n\n#### b) 保持距离型：RANGED\n\n```json
ai_type: RANGED
ai_config: {
  "minDistance": 200,
  "maxDistance": 600,
  "retreatAngleVariance": 30,
  "repositionCooldown": 2.0
}
```\n\n- 距离 < `minDistance`：后退（远离玩家方向 ± `retreatAngleVariance`°随机）\n- 距离 > `maxDistance`：接近（朝玩家移动）\n- 介于两者：待机（优先播放 `idle`，若未配置则播放 `walk`）\n\n#### c) 逃跑型：ESCAPE（受击逃离）\n\n```json
ai_type: ESCAPE
ai_config: {
  "fleeSpeed": 600,
  "fleeDurationmin": 1.5,
  "fleeDurationmax": 5.5,
  "retreatAngleVariance": 30,
  "repositionCooldown": 2.0
}
```\n\n- 默认待机不动（优先 `idle`，无则 `walk`）\n- **受到攻击**：若不在冷却中，触发逃跑\n  - 方向：远离玩家方向 ± `retreatAngleVariance`°随机\n  - 速度：`fleeSpeed`\n  - 时间：在 `fleeDurationmin~fleeDurationmax` 随机\n- 逃跑结束：回到待机\n\n#### d) 静止型：STILL\n\n- **参数**：无\n- **行为**：创建后不主动移动（但仍会按基础碰撞攻击机制在 `attack_range` 内造成触碰伤害）\n*** End Patch  天天赢彩票

### 步骤 5：测试新敌人

在波次配置 JSON 中添加新敌人进行测试：

```json
{
    "enemies": [
        { "id": "goblin", "count": 5 }
    ]
}
```

---

## 二、添加有技能的敌人

### 冲锋技能敌人

```
skill_type: CHARGING
skill_config: {
    "trigger_distance": 500.0,    # 触发距离
    "charge_speed": 800.0,        # 冲锋速度
    "charge_distance": 600.0,     # 冲锋距离
    "cooldown": 3.0,              # 冷却时间
    "extra_damage": 10,           # 额外伤害
    "prepare_time": 0.3           # 准备时间
}
```

### 射击技能敌人

```
skill_type: SHOOTING
skill_config: {
    "shoot_range": 600.0,         # 射击范围
    "shoot_interval": 1.0,        # 射击间隔
    "bullet_speed": 350.0,        # 子弹速度
    "bullet_damage": 5,           # 子弹伤害
    "bullet_id": "basic"          # 子弹ID
}
```

### 自爆技能敌人

```
skill_type: EXPLODING
skill_config: {
    "trigger_condition": "low_hp",  # 触发条件：low_hp / distance / on_death
    "explosion_range": 300.0,       # 爆炸范围
    "explosion_damage": 30,         # 爆炸伤害
    "low_hp_threshold": 0.3,        # 低血量阈值（30%）
    "countdown_duration": 3.0       # 倒数时长
}
```

### 为技能敌人添加技能动画

1. 在 SpriteFrames 中添加技能动画帧
2. 在 EnemyData 的 animations 中配置映射：

```
animations: {
    "walk": "walk",
    "skill_prepare": "charge_ready",    # 技能准备动画
    "skill_execute": "charge_attack"    # 技能执行动画
}
```

3. （可选）在 AnimationPlayer 中添加复杂动画：
   - 打开敌人预制场景
   - 选择 AnimationPlayer 节点
   - 创建动画（如 `skill_prepare`）
   - 添加轨道控制 scale/rotation/shader 等

---

## 三、修改现有敌人

### 修改数值属性

1. 打开 `resources/enemies/data/敌人ID.tres`
2. 在 Inspector 中修改数值
3. 保存

**无需重启**，下次生成该敌人时自动生效。

### 修改外观

1. 打开 `scenes/enemies/prefabs/敌人名.tscn`
2. 修改对应节点属性
3. 保存

### 修改动画

1. 打开 `resources/enemies/animations/敌人名_sprites.tres`
2. 在 SpriteFrames 编辑器中修改
3. 保存

### 更换动画资源

1. 打开敌人预制场景
2. 选择 AnimatedSprite2D 节点
3. 拖拽新的 SpriteFrames 资源到 Sprite Frames 属性

---

## 四、常见配置示例

### 示例 1：基础敌人（无技能）

**goblin.tres:**
```
enemy_name: "哥布林"
scene_path: "res://scenes/enemies/prefabs/goblin.tscn"
max_hp: 15
attack_damage: 4
move_speed: 350.0
skill_type: NONE
scale: Vector2(0.5, 0.5)
```

### 示例 2：快速敌人

**fast_goblin.tres:**
```
enemy_name: "快速哥布林"
scene_path: "res://scenes/enemies/prefabs/fast_goblin.tscn"
max_hp: 8
attack_damage: 2
move_speed: 550.0       # 更快的移动速度
skill_type: NONE
scale: Vector2(0.4, 0.4)
```

### 示例 3：坦克敌人

**tank_goblin.tres:**
```
enemy_name: "重装哥布林"
scene_path: "res://scenes/enemies/prefabs/tank_goblin.tscn"
max_hp: 50              # 更高的血量
attack_damage: 10
move_speed: 180.0       # 更慢的移动速度
skill_type: NONE
scale: Vector2(0.8, 0.8)
shake_amount: 15.0      # 更强的死亡震动
```

### 示例 4：精英敌人（带冲锋）

**elite_goblin.tres:**
```
enemy_name: "精英哥布林"
scene_path: "res://scenes/enemies/prefabs/elite_goblin.tscn"
max_hp: 30
attack_damage: 8
move_speed: 400.0
skill_type: CHARGING
skill_config: {
    "trigger_distance": 400.0,
    "charge_speed": 700.0,
    "charge_distance": 500.0,
    "cooldown": 4.0,
    "extra_damage": 12,
    "prepare_time": 0.4
}
animations: {
    "walk": "walk",
    "skill_prepare": "charge_prepare",
    "skill_execute": "charge"
}
scale: Vector2(0.6, 0.6)
```

---

## 五、调试技巧

### 1. 检查敌人是否正确加载

游戏启动时，控制台会显示：
```
[EnemyDatabase] ✓ 加载敌人: goblin
[EnemyDatabase] 加载完成，共 X 个敌人
```

### 2. 检查场景是否正确加载

生成敌人时，控制台会显示：
```
[EnemySpawner V3] ✓ 缓存敌人场景: res://scenes/enemies/prefabs/goblin.tscn
[EnemySpawner V3] 生成敌人：goblin 波次:1 HP倍数:1.0 实际HP:15
```

### 3. 常见问题排查

| 问题 | 可能原因 | 解决方法 |
|-----|---------|---------|
| 敌人不显示 | scene_path 路径错误 | 检查 .tres 中的路径 |
| 动画不播放 | SpriteFrames 未设置 | 检查预制场景的 AnimatedSprite2D |
| 动画名不对 | animations 映射错误 | 检查 .tres 中的 animations 字典 |
| 敌人太大/太小 | scale 配置问题 | 同时检查 .tres 和场景中的 scale |
| 碰撞体位置不对 | CollisionShape2D 未调整 | 打开场景调整碰撞体 |

### 4. 热重载敌人数据

在游戏运行时，可以调用以下方法重新加载敌人数据：
```gdscript
EnemyDatabase.reload_enemies()
```

---

## 六、命名规范

### 文件命名

| 类型 | 格式 | 示例 |
|-----|------|------|
| Sprite Sheet | `敌人名-动作-Sheet.png` | `goblin-run-Sheet.png` |
| SpriteFrames | `敌人名_sprites.tres` | `goblin_sprites.tres` |
| 预制场景 | `敌人名.tscn` | `goblin.tscn` |
| EnemyData | `敌人ID.tres` | `goblin.tres` |

### 敌人ID命名

- 使用小写字母和下划线
- 基础敌人：`goblin`、`slime`
- 变种敌人：`fast_goblin`、`elite_slime`
- 技能敌人：`charging_goblin`、`shooting_slime`

### 动画命名

- `walk` - 走路/移动（必需）
- `idle` - 待机
- `attack` - 普通攻击
- `hurt` - 受伤
- `skill_prepare` - 技能准备
- `skill_execute` - 技能执行
- `death` - 死亡

---

## 七、快速检查清单

添加新敌人时，确保完成以下步骤：

- [ ] 准备好 Sprite Sheet 图片
- [ ] 创建 SpriteFrames 资源，添加 `walk` 动画
- [ ] 创建预制场景，设置好 AnimatedSprite2D
- [ ] 调整 shadow 位置和大小
- [ ] 调整 CollisionShape2D 位置和大小
- [ ] 创建 EnemyData 资源
- [ ] 配置 scene_path 指向预制场景
- [ ] 配置数值属性
- [ ] （如有技能）配置 skill_type 和 skill_config
- [ ] （如有技能动画）配置 animations 映射
- [ ] 在波次配置中测试

